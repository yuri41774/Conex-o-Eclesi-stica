<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o Eclesi√°stica - In√≠cio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: block;
        }
        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fade-in-down 0.8s ease-out forwards; }
        .animate-fade-in-up { animation: fade-in-up 0.8s ease-out forwards; animation-delay: 0.2s; }
        .hidden { display: none; }
        .notification-transition { transition: opacity 0.5s ease-in-out; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hamburger-menu {
            position: fixed; top: 0; right: 0; width: 256px; height: 100%;
            background-color: #1f2937; transform: translateX(100%);
            transition: transform 0.3s ease-in-out; z-index: 50;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2); padding: 1.5rem;
            display: flex; flex-direction: column;
        }
        .hamburger-menu.open { transform: translateX(0); }
        .hamburger-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 40; display: none;
        }
        .hamburger-menu-overlay.open { display: block; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 p-4 relative">

    <div id="loading-message" class="flex items-center justify-center min-h-screen bg-gray-100 absolute inset-0 z-10">
        <p class="text-xl text-gray-700">Carregando aplica√ß√£o...</p>
    </div>

    <div id="notification-bar" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-green-500 text-white text-center py-3 rounded-b-lg shadow-lg z-50 opacity-0 notification-transition hidden">
        </div>

    <header id="main-header" class="w-full max-w-4xl mx-auto bg-orange-600 text-white p-4 rounded-xl shadow-lg flex justify-between items-center mb-4 z-20 animate-fade-in-down hidden">
        <h1 class="text-3xl font-bold">Conex√£o Eclesi√°stica</h1>
        <div class="flex items-center space-x-4">
            <div id="user-profile-header" class="flex items-center space-x-2">
                <img id="profile-avatar" class="w-10 h-10 rounded-full border-2 border-white hidden" src="https://placehold.co/40x40/cccccc/000000?text=üë§" alt="Avatar do Usu√°rio">
                <span id="user-name-display" class="text-lg font-semibold">Visitante</span>
            </div>
            
            <button id="hamburger-icon" class="flex flex-col justify-around w-8 h-8 bg-orange-700 p-1 rounded-md cursor-pointer">
                <span class="block h-0.5 bg-white rounded-full"></span>
                <span class="block h-0.5 bg-white rounded-full"></span>
                <span class="block h-0.5 bg-white rounded-full"></span>
            </button>
        </div>
    </header>

    <nav id="hamburger-menu" class="hamburger-menu">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Menu</h2>
            <button id="close-hamburger-menu" class="text-white hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <ul class="flex flex-col space-y-4">
            <li>
                <a href="admin.html" id="menu-admin-button" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 block">
                    Administrador
                </a>
            </li>
            <li>
                <a href="bible.html" id="menu-bible-button" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 block">
                    B√≠blia
                </a>
            </li>
            <li id="menu-login-item">
                <button id="menu-login-button" class="w-full text-left bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Login
                </button>
            </li>
            <li id="menu-logout-item" class="hidden">
                <button id="menu-logout-button" class="w-full text-left bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </li>
        </ul>
    </nav>
    <div id="hamburger-menu-overlay" class="hamburger-menu-overlay"></div>

    <div id="app-content" class="hidden bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl mx-auto text-center">
        <p class="text-xl text-gray-700 mb-8 animate-fade-in-up">
            Bem-vindo(a)! Sua plataforma de intera√ß√£o e estudo.
        </p>

        <p class="text-sm text-gray-500 mb-6">
            Seu ID de Usu√°rio: <span id="user-id-display" class="font-mono bg-gray-100 px-2 py-1 rounded-md text-purple-600 break-all"></span>
        </p>

        <div class="mt-8 bg-blue-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-blue-700 mb-4">Mural de Not√≠cias e Posts</h2>
            <div id="posts-container" class="h-64 overflow-y-auto border border-gray-300 rounded-lg p-4 mb-4 bg-white shadow-sm">
                </div>
            <div id="add-post-section" class="flex gap-2 hidden">
                <textarea
                    id="new-post-content-textarea"
                    placeholder="Escreva seu post aqui..."
                    rows="3"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                ></textarea>
                <button
                    id="add-post-button"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-md self-end"
                >
                    Publicar
                </button>
            </div>
        </div>
    </div>

    <button id="toggle-floating-chat-button" class="fixed bottom-4 right-4 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-lg z-50 transition duration-300 text-2xl font-bold hidden">
        üí¨
    </button>

    <div id="floating-chat-container" class="hidden fixed bottom-20 right-4 w-80 h-[400px] bg-white rounded-lg shadow-2xl flex flex-col z-40 overflow-hidden">
        <div class="bg-purple-700 text-white p-3 flex justify-between items-center rounded-t-lg">
            <h3 class="text-lg font-bold">Chat R√°pida</h3>
            <button id="close-floating-chat-button" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="floating-messages-container" class="flex-grow overflow-y-auto p-4 bg-gray-50">
            </div>
        <div class="p-4 border-t border-gray-200 flex gap-2">
            <input
                type="text"
                id="floating-new-message-input"
                placeholder="Digite sua mensagem..."
                class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
            />
            <button
                id="floating-send-message-button"
                class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 ease-in-out shadow-md"
            >
                Enviar
            </button>
        </div>
    </div>

    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="flex justify-center mb-6">
                <button id="show-login-form-button" class="px-4 py-2 text-lg font-semibold border-b-2 border-purple-600 text-purple-600 focus:outline-none">Login</button>
                <button id="show-register-form-button" class="px-4 py-2 text-lg font-semibold border-b-2 border-transparent text-gray-500 hover:text-purple-600 focus:outline-none">Registrar</button>
            </div>

            <form id="login-form" class="space-y-4">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Entrar</h2>
                <div>
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2 text-left">Email:</label>
                    <input type="email" id="login-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <!-- Seguran√ßa: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div>
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Senha:</label>
                    <input type="password" id="login-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <!-- Seguran√ßa: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Entrar
                </button>
                <div class="text-center mt-4">
                    <p class="text-gray-600">ou</p>
                    <button type="button" id="anonymous-login-button" class="mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                        Entrar como Convidado (An√¥nimo)
                    </button>
                </div>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Registrar</h2>
                <div>
                    <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2 text-left">Email:</label>
                    <input type="email" id="register-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <!-- Seguran√ßa: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div>
                    <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Senha:</label>
                    <input type="password" id="register-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <!-- Seguran√ßa: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div>
                    <label for="register-confirm-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Confirmar Senha:</label>
                    <input type="password" id="register-confirm-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <!-- Seguran√ßa: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-first-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Nome:</label>
                        <input type="text" id="register-first-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div>
                        <label for="register-last-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Sobrenome:</label>
                        <input type="text" id="register-last-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                    </div>
                </div>
                <div>
                    <label for="register-dob" class="block text-gray-700 text-sm font-bold mb-2 text-left">Data de Nascimento:</label>
                    <input type="date" id="register-dob" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div>
                    <label for="register-gender" class="block text-gray-700 text-sm font-bold mb-2 text-left">G√™nero:</label>
                    <select id="register-gender" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Selecione</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="register-phone" class="block text-gray-700 text-sm font-bold mb-2 text-left">Telefone:</label>
                    <input type="tel" id="register-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-street" class="block text-gray-700 text-sm font-bold mb-2 text-left">Rua/Avenida:</label>
                        <input type="text" id="register-street" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-city" class="block text-gray-700 text-sm font-bold mb-2 text-left">Cidade:</label>
                        <input type="text" id="register-city" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-state" class="block text-gray-700 text-sm font-bold mb-2 text-left">Estado:</label>
                        <input type="text" id="register-state" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-zip" class="block text-gray-700 text-sm font-bold mb-2 text-left">CEP:</label>
                        <input type="text" id="register-zip" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label for="register-church-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Nome da Igreja (Opcional):</label>
                    <input type="text" id="register-church-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="register-church-role" class="block text-gray-700 text-sm font-bold mb-2 text-left">Fun√ß√£o na Igreja:</label>
                    <select id="register-church-role" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Selecione</option>
                        <option value="membro">Membro</option>
                        <option value="lider">L√≠der</option>
                        <option value="voluntario">Volunt√°rio</option>
                        <option value="pastor">Pastor</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="register-terms" class="mr-2 leading-tight" required>
                    <label for="register-terms" class="text-sm text-gray-700">Eu concordo com os <a href="#" class="text-purple-600 hover:underline">Termos e Condi√ß√µes</a></label>
                </div>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Registrar
                </button>
            </form>
        </div>
    </div>

    <div id="username-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm relative text-center">
            <button id="close-username-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Qual √© o seu nome, Convidado?</h2>
            <input type="text" id="anonymous-username-input" placeholder="Digite seu nome" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500 mb-4" required>
            <button id="save-anonymous-username-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300" autocomplete="off">
                Salvar Nome
            </button>
        </div>
    </div>

    <footer id="main-footer" class="w-full max-w-4xl mx-auto bg-gray-800 text-white p-4 rounded-xl shadow-lg text-center mt-8 hidden">
        <p class="text-sm">&copy; 2025 Conex√£o Eclesi√°stica. Todos os direitos reservados.</p>
        <p class="text-xs mt-2">Desenvolvido com F√© e Tecnologia.</p>
    </footer>

    <script type="module">
        // Importa os m√≥dulos necess√°rios do Firebase
        // --- SEGURAN√áA: Fun√ß√£o para sanitizar entradas (b√°sico contra XSS) ---
        function sanitizeInput(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"'/]/g, function (c) {
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;'}[c]);
            });
        }
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Vari√°veis globais para Firebase e dados do usu√°rio
        let db;
        let auth;
        let userId = null;
        let userName = null; // Novo para armazenar o nome do usu√°rio
        let isAuthReady = false;
        let analytics;

        // Configura√ß√µes do Firebase (fornecidas pelo usu√°rio)
        const firebaseConfig = {
            apiKey: "AIzaSyBfFQ0wZIe1WY0Lw3L0Rlr97UrnnSydurM", // Chave de API do Firebase
            authDomain: "conexao-eclesiastica.firebaseapp.com",
            databaseURL: "https://conexao-eclesiastica-default-rtdb.firebaseio.com", // Adicionado
            projectId: "conexao-eclesiastica",
            storageBucket: "conexao-eclesiastica.firebasestorage.app",
            messagingSenderId: "1009771043961",
            appId: "1:1009771043961:web:6a8d829618f0b0f8a508a8",
            measurementId: "G-W0701VYFK9"
        };
        const appId = firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Dados mock para configura√ß√µes da aplica√ß√£o (apenas para simula√ß√£o, em um projeto real viriam do Firestore)
        let appSettings = {
            welcomeMessage: "Bem-vindo(a) √† Conex√£o Eclesi√°stica! Que a paz de Deus esteja com voc√™.",
            defaultChatMessage: "Ol√° a todos! Compartilhem suas b√™n√ß√£os e ora√ß√µes.",
            allowAnonymousPosting: false,
            publicChatEnabled: true,
            maintenanceMode: false
        };

        // Fun√ß√£o para exibir um loading global (spinner ou mensagem)
        function showGlobalLoading(show) {
            let loadingDiv = document.getElementById('global-loading-indicator');
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'global-loading-indicator';
                loadingDiv.style.position = 'fixed';
                loadingDiv.style.top = '0';
                loadingDiv.style.left = '0';
                loadingDiv.style.width = '100vw';
                loadingDiv.style.height = '100vh';
                loadingDiv.style.background = 'rgba(0,0,0,0.3)';
                loadingDiv.style.display = 'flex';
                loadingDiv.style.alignItems = 'center';
                loadingDiv.style.justifyContent = 'center';
                loadingDiv.style.zIndex = '9999';
                loadingDiv.innerHTML = '<div style="background:#fff;padding:32px 48px;border-radius:16px;box-shadow:0 2px 16px #0002;font-size:1.2rem;font-weight:bold;">Carregando...</div>';
                document.body.appendChild(loadingDiv);
            }
            loadingDiv.style.display = show ? 'flex' : 'none';
        }

        // Fun√ß√£o para inicializar o Firebase e configurar a autentica√ß√£o
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usu√°rio autenticado:", userId);

                        const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'details');
                        const userProfileSnap = await getDoc(userProfileRef);
                        if (userProfileSnap.exists() && userProfileSnap.data().firstName) {
                            userName = userProfileSnap.data().firstName;
                            document.getElementById('user-name-display').textContent = userName;
                            document.getElementById('profile-avatar').classList.remove('hidden');
                            document.getElementById('user-id-display').textContent = `${userName} (${userId.substring(0, 8)}...)`;
                        } else {
                            userName = null;
                            document.getElementById('user-name-display').textContent = user.isAnonymous ? 'Convidado' : 'Usu√°rio';
                            document.getElementById('profile-avatar').classList.add('hidden');
                            document.getElementById('user-id-display').textContent = user.isAnonymous ? `${userId} (An√¥nimo)` : userId;
                        }
                        
                        const addPostSection = document.getElementById('add-post-section');
                        if (addPostSection) {
                            if (user.isAnonymous) {
                                addPostSection.classList.add('hidden');
                            } else {
                                addPostSection.classList.remove('hidden');
                            }
                        }

                        const menuLoginItem = document.getElementById('menu-login-item');
                        const menuLogoutItem = document.getElementById('menu-logout-item');
                        if (menuLoginItem) menuLoginItem.classList.add('hidden');
                        if (menuLogoutItem) menuLogoutItem.classList.remove('hidden');

                    } else {
                        userId = null;
                        userName = null;
                        console.log("Usu√°rio n√£o autenticado.");
                        const userIdDisplay = document.getElementById('user-id-display');
                        if (userIdDisplay) userIdDisplay.textContent = 'N√£o dispon√≠vel';
                        const userNameDisplay = document.getElementById('user-name-display');
                        if (userNameDisplay) userNameDisplay.textContent = 'Visitante';
                        const profileAvatar = document.getElementById('profile-avatar');
                        if (profileAvatar) profileAvatar.classList.add('hidden');
                        
                        const addPostSection = document.getElementById('add-post-section');
                        if (addPostSection) addPostSection.classList.add('hidden');

                        const menuLoginItem = document.getElementById('menu-login-item');
                        const menuLogoutItem = document.getElementById('menu-logout-item');
                        if (menuLoginItem) menuLoginItem.classList.remove('hidden');
                        if (menuLogoutItem) menuLogoutItem.classList.add('hidden');

                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Autenticado com token personalizado.");
                            } catch (customTokenError) {
                                console.warn("Falha na autentica√ß√£o com token personalizado:", customTokenError);
                            }
                        }
                    }
                    isAuthReady = true;
                    // Mostra o conte√∫do da aplica√ß√£o ap√≥s a autentica√ß√£o
                    document.getElementById('loading-message')?.classList.add('hidden');
                    document.getElementById('app-content')?.classList.remove('hidden');
                    document.getElementById('main-header')?.classList.remove('hidden');
                    document.getElementById('toggle-floating-chat-button')?.classList.remove('hidden');
                    document.getElementById('main-footer')?.classList.remove('hidden');

                    setupChatListener();
                    setupPostsListener();
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                document.getElementById('loading-message').textContent = 'Erro ao carregar a aplica√ß√£o.';
            }
        };

        const setupChatListener = () => {
            if (db && userId && isAuthReady) {
                console.log("Configurando listener de mensagens para userId:", userId);
                const publicChatCollectionRef = collection(db, `artifacts/${appId}/public/data/chatMessages`);
                const q = query(publicChatCollectionRef); 

                onSnapshot(q, (snapshot) => {
                    const messagesContainer = document.getElementById('floating-messages-container');
                    if (!messagesContainer) return;

                    messagesContainer.innerHTML = '';
                    const fetchedMessages = [];
                    snapshot.docs.forEach(doc => {
                        fetchedMessages.push({ id: doc.id, ...doc.data() });
                    });
                    fetchedMessages.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                    if (fetchedMessages.length === 0) {
                        messagesContainer.innerHTML = '<p class="text-gray-500 italic">Nenhuma mensagem ainda. Seja o primeiro a enviar!</p>';
                    } else {
                        fetchedMessages.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.className = `mb-2 p-2 rounded-lg max-w-[80%] ${msg.userId === userId ? 'bg-purple-200 ml-auto text-right' : 'bg-gray-200 mr-auto text-left'}`;
                            const senderDisplayName = msg.senderName || `Usu√°rio: ${msg.userId.substring(0, 8)}...`;
                            const timestampText = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : 'Data desconhecida';
                            msgDiv.innerHTML = `
                                <p class="text-sm font-semibold text-purple-800">${msg.userId === userId ? 'Voc√™' : senderDisplayName}</p>
                                <p class="text-gray-800">${msg.text}</p>
                                <span class="text-xs text-gray-500">${timestampText}</span>
                            `;
                            messagesContainer.appendChild(msgDiv);
                        });
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    console.log("Mensagens atualizadas:", fetchedMessages);
                }, (error) => {
                    console.error("Erro ao ouvir mensagens:", error);
                });
            }
        };

        const setupPostsListener = () => {
            if (db && userId && isAuthReady) {
                console.log("Configurando listener de posts para userId:", userId);
                const publicPostsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
                const q = query(publicPostsCollectionRef);

                onSnapshot(q, (snapshot) => {
                    const postsContainer = document.getElementById('posts-container');
                    if (!postsContainer) return;

                    postsContainer.innerHTML = '';
                    const fetchedPosts = [];
                    snapshot.docs.forEach(doc => {
                        fetchedPosts.push({ id: doc.id, ...doc.data() });
                    });
                    fetchedPosts.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                    if (fetchedPosts.length === 0) {
                        postsContainer.innerHTML = '<p class="text-gray-500 italic">Nenhum post ainda. Compartilhe algo!</p>';
                    } else {
                        fetchedPosts.forEach(post => {
                            const postDiv = document.createElement('div');
                            postDiv.className = "mb-4 p-3 border-b border-gray-200 last:border-b-0";
                            const senderDisplayName = post.senderName || `Usu√°rio: ${post.userId.substring(0, 8)}...`;
                            const timestampText = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : 'Data desconhecida';
                            postDiv.innerHTML = `
                                <p class="text-sm font-semibold text-blue-800">${post.userId === userId ? 'Voc√™' : senderDisplayName}</p>
                                <p class="text-gray-800 text-lg">${post.content}</p>
                                <span class="text-xs text-gray-500">${timestampText}</span>
                            `;
                            postsContainer.appendChild(postDiv);
                        });
                    }
                    postsContainer.scrollTop = postsContainer.scrollHeight;
                    console.log("Posts atualizadas:", fetchedPosts);
                }, (error) => {
                    console.error("Erro ao ouvir posts:", error);
                });
            }
        };

        const showNotification = (message, type = 'success') => {
            const notificationBar = document.getElementById('notification-bar');
            if (!notificationBar) return;

            notificationBar.textContent = message;
            notificationBar.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-gray-700');

            if (type === 'success') {
                notificationBar.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationBar.classList.add('bg-red-500');
            } else {
                notificationBar.classList.add('bg-gray-700');
            }

            notificationBar.classList.remove('opacity-0');
            notificationBar.classList.add('opacity-100');

            setTimeout(() => {
                notificationBar.classList.remove('opacity-100');
                notificationBar.classList.add('opacity-0');
                setTimeout(() => {
                    notificationBar.classList.add('hidden');
                }, 500);
            }, 3000);
        };

        const sendMessage = async () => {
            const newMessageInput = document.getElementById('floating-new-message-input');
            if (!newMessageInput) return;
            let newMessage = newMessageInput.value.trim();
            newMessage = sanitizeInput(newMessage);

            if (!db || !userId || !newMessage) {
                showNotification("Por favor, digite uma mensagem.", 'error');
                return;
            }
            try {
                const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/chatMessages`);
                await addDoc(chatCollectionRef, {
                    text: newMessage,
                    userId: userId,
                    senderName: sanitizeInput(userName || `An√¥nimo (${userId.substring(0,4)})`),
                    timestamp: new Date(),
                });
                newMessageInput.value = '';
                showNotification("Mensagem enviada com sucesso!", 'success');
            } catch (error) {
                showNotification("Erro ao enviar mensagem.", 'error');
                console.error("Erro ao enviar mensagem:", error);
            }
        };

        const addPost = async () => {
            const newPostContentTextarea = document.getElementById('new-post-content-textarea');
            if (!newPostContentTextarea) return;
            let newPostContent = newPostContentTextarea.value.trim();
            newPostContent = sanitizeInput(newPostContent);

            if (!userId) {
                showNotification("Voc√™ precisa estar logado para postar.", 'error');
                return;
            }

            if (auth.currentUser && auth.currentUser.isAnonymous) {
                showNotification("Usu√°rios an√¥nimos n√£o podem criar posts. Por favor, registre-se ou fa√ßa login.", 'error');
                return;
            }

            if (!db || !newPostContent) {
                showNotification("Por favor, digite o conte√∫do do post.", 'error');
                return;
            }
            try {
                const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
                await addDoc(postsCollectionRef, {
                    content: newPostContent,
                    userId: userId,
                    senderName: sanitizeInput(userName),
                    timestamp: new Date(),
                });
                newPostContentTextarea.value = '';
                showNotification("Post publicado com sucesso!", 'success');
            } catch (error) {
                showNotification("Erro ao publicar post.", 'error');
                console.error("Erro ao publicar post:", error);
            }
        };

        // Fun√ß√µes para o Modal de Autentica√ß√£o
        const toggleAuthModal = (showLogin = true) => {
            const authModal = document.getElementById('auth-modal');
            if (!authModal) return;
            authModal.classList.toggle('hidden');
            
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (showLogin) {
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
            } else {
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
            }
        };

        const showLoginForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showLoginFormButton = document.getElementById('show-login-form-button');
            const showRegisterFormButton = document.getElementById('show-register-form-button');

            if (loginForm) loginForm.classList.remove('hidden');
            if (registerForm) registerForm.classList.add('hidden');
            
            if (showLoginFormButton) {
                showLoginFormButton.classList.add('border-purple-600', 'text-purple-600');
                showLoginFormButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
            if (showRegisterFormButton) {
                showRegisterFormButton.classList.remove('border-purple-600', 'text-purple-600');
                showRegisterFormButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
        };

        const showRegisterForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showLoginFormButton = document.getElementById('show-login-form-button');
            const showRegisterFormButton = document.getElementById('show-register-form-button');

            if (loginForm) loginForm.classList.add('hidden');
            if (registerForm) registerForm.classList.remove('hidden');
            
            if (showRegisterFormButton) {
                showRegisterFormButton.classList.add('border-purple-600', 'text-purple-600');
                showRegisterFormButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
            if (showLoginFormButton) {
                showLoginFormButton.classList.remove('border-purple-600', 'text-purple-600');
                showLoginFormButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
        };

        const signInAnonymouslyUser = async () => {
            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                showNotification("Login como convidado realizado com sucesso!", 'success');
                toggleAuthModal(false);

                const usernameModal = document.getElementById('username-modal');
                const anonymousUsernameInput = document.getElementById('anonymous-username-input');

                if (usernameModal) usernameModal.classList.remove('hidden');
                if (anonymousUsernameInput) anonymousUsernameInput.focus();

            } catch (error) {
                showNotification("Erro ao entrar como convidado. Tente novamente.", 'error');
                console.error("Erro no login an√¥nimo:", error);
            }
        };

        const saveAnonymousUsername = async () => {
            let inputName = document.getElementById('anonymous-username-input').value.trim();
            inputName = sanitizeInput(inputName);
            if (!inputName) {
                showNotification("Por favor, digite um nome.", 'error');
                return;
            }

            if (auth.currentUser && db) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile`, 'details');
                    await setDoc(userProfileRef, {
                        firstName: inputName,
                        isAnonymousProfile: true,
                        registeredAt: new Date(),
                    }, { merge: true });

                    userName = inputName;
                    document.getElementById('user-id-display').textContent = `${userName} (An√¥nimo)`;
                    showNotification("Nome salvo com sucesso!", 'success');
                    
                    const usernameModal = document.getElementById('username-modal');
                    const anonymousUsernameInput = document.getElementById('anonymous-username-input');
                    if (usernameModal) usernameModal.classList.add('hidden');
                    if (anonymousUsernameInput) anonymousUsernameInput.value = '';
                } catch (error) {
                    showNotification("Erro ao salvar o nome.", 'error');
                    console.error("Erro ao salvar nome an√¥nimo:", error);
                }
            } else {
                showNotification("Erro: Usu√°rio n√£o autenticado ou DB n√£o dispon√≠vel.", 'error');
            }
        };

        const handleRegister = async (event) => {
            event.preventDefault();

            const email = sanitizeInput(document.getElementById('register-email').value);
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const firstName = sanitizeInput(document.getElementById('register-first-name').value);
            const lastName = sanitizeInput(document.getElementById('register-last-name').value);
            const dob = document.getElementById('register-dob').value;
            const gender = sanitizeInput(document.getElementById('register-gender').value);
            const phone = sanitizeInput(document.getElementById('register-phone').value);
            const street = sanitizeInput(document.getElementById('register-street').value);
            const city = sanitizeInput(document.getElementById('register-city').value);
            const state = sanitizeInput(document.getElementById('register-state').value);
            const zip = sanitizeInput(document.getElementById('register-zip').value);
            const churchName = sanitizeInput(document.getElementById('register-church-name').value);
            const churchRole = sanitizeInput(document.getElementById('register-church-role').value);
            const termsAccepted = document.getElementById('register-terms').checked;

            if (password !== confirmPassword) {
                showNotification("As senhas n√£o coincidem.", 'error');
                return;
            }
            if (!termsAccepted) {
                showNotification("Voc√™ deve aceitar os termos e condi√ß√µes.", 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'details');
                await setDoc(userProfileRef, {
                    firstName: firstName,
                    lastName: lastName,
                    dob: dob,
                    gender: gender,
                    phone: phone,
                    address: {
                        street: street,
                        city: city,
                        state: state,
                        zip: zip,
                    },
                    churchName: churchName,
                    churchRole: churchRole,
                    registeredAt: new Date(),
                    isAnonymousProfile: false,
                });

                showNotification("Registro e login bem-sucedidos!", 'success');
                toggleAuthModal(false);
                document.getElementById('register-form').reset();
            }
            catch (error) {
                let errorMessage = "Erro ao registrar. Tente novamente.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este e-mail j√° est√° em uso.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Endere√ßo de e-mail inv√°lido.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                }
                showNotification(errorMessage, 'error');
                console.error("Erro no registro:", error);
            }
        };

        const handleLogin = async (event) => {
            event.preventDefault();

            const email = sanitizeInput(document.getElementById('login-email').value);
            const password = document.getElementById('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification("Login bem-sucedido!", 'success');
                toggleAuthModal(false);
                document.getElementById('login-form').reset();
            } catch (error) {
                let errorMessage = "Erro ao fazer login. Verifique suas credenciais.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "E-mail ou senha inv√°lidos.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Endere√ßo de e-mail inv√°lido.";
                }
                showNotification(errorMessage, 'error');
                console.error("Erro no login:", error);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                showNotification("Logout realizado com sucesso!", 'info');
                console.log("Usu√°rio deslogado.");
            } catch (error) {
                showNotification("Erro ao fazer logout.", 'error');
                console.error("Erro no logout:", error);
            }
        };

        // Fun√ß√µes para o menu hamb√∫rguer e chat flutuante
        const toggleFloatingChat = () => {
            const floatingChatContainer = document.getElementById('floating-chat-container');
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');

            if (!floatingChatContainer) return;

            floatingChatContainer.classList.toggle('hidden');
            if (hamburgerMenu && hamburgerMenu.classList.contains('open')) {
                hamburgerMenu.classList.remove('open');
                if (hamburgerOverlay) hamburgerOverlay.classList.remove('open');
            }
        };

        const toggleHamburgerMenu = () => {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');
            const floatingChatContainer = document.getElementById('floating-chat-container');

            if (!hamburgerMenu || !hamburgerOverlay) return;

            hamburgerMenu.classList.toggle('open');
            hamburgerOverlay.classList.toggle('open');

            if (floatingChatContainer && !floatingChatContainer.classList.contains('hidden')) {
                floatingChatContainer.classList.add('hidden');
            }
        };

        // Adiciona listeners ao carregar o DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Seguran√ßa: For√ßa todos os links externos a terem rel="noopener noreferrer" e target="_blank"
            document.querySelectorAll('a[href^="http"]').forEach(link => {
                link.setAttribute('rel', 'noopener noreferrer');
                link.setAttribute('target', '_blank');
            });

            // Acessibilidade: foco autom√°tico em modais
            const authModal = document.getElementById('auth-modal');
            const usernameModal = document.getElementById('username-modal');
            if (authModal) {
                authModal.addEventListener('transitionend', () => {
                    if (!authModal.classList.contains('hidden')) {
                        const firstInput = authModal.querySelector('input, button, select, textarea');
                        if (firstInput) firstInput.focus();
                    }
                });
            }
            if (usernameModal) {
                usernameModal.addEventListener('transitionend', () => {
                    if (!usernameModal.classList.contains('hidden')) {
                        const firstInput = usernameModal.querySelector('input, button');
                        if (firstInput) firstInput.focus();
                    }
                });
            }
            // Fecha modais com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (authModal && !authModal.classList.contains('hidden')) {
                        authModal.classList.add('hidden');
                    }
                    if (usernameModal && !usernameModal.classList.contains('hidden')) {
                        usernameModal.classList.add('hidden');
                    }
                }
            });

            // Desabilita bot√µes durante loading
            const floatingSendMessageButton = document.getElementById('floating-send-message-button');
            if (floatingSendMessageButton) {
                floatingSendMessageButton.addEventListener('click', async (e) => {
                    floatingSendMessageButton.disabled = true;
                    await sendMessage();
                    floatingSendMessageButton.disabled = false;
                });
            }
            const addPostButton = document.getElementById('add-post-button');
            if (addPostButton) {
                addPostButton.addEventListener('click', async (e) => {
                    addPostButton.disabled = true;
                    await addPost();
                    addPostButton.disabled = false;
                });
            }
            // Inicializa Firebase
            initFirebase();

            // Esconde a mensagem de carregamento e mostra o conte√∫do principal
            document.getElementById('loading-message')?.classList.add('hidden');
            document.getElementById('app-content')?.classList.remove('hidden');
            document.getElementById('main-header')?.classList.remove('hidden');
            document.getElementById('toggle-floating-chat-button')?.classList.remove('hidden');
            document.getElementById('main-footer')?.classList.remove('hidden');

            // Event Listeners para o Cabe√ßalho e Menu Hamb√∫rguer
            document.getElementById('hamburger-icon')?.addEventListener('click', toggleHamburgerMenu);
            document.getElementById('close-hamburger-menu')?.addEventListener('click', toggleHamburgerMenu);
            document.getElementById('hamburger-menu-overlay')?.addEventListener('click', toggleHamburgerMenu);

            // Event Listeners para o Chat Flutuante
            document.getElementById('toggle-floating-chat-button')?.addEventListener('click', toggleFloatingChat);
            document.getElementById('close-floating-chat-button')?.addEventListener('click', toggleFloatingChat);
            document.getElementById('floating-send-message-button')?.addEventListener('click', sendMessage);

            // Event Listeners para Posts
            document.getElementById('add-post-button')?.addEventListener('click', addPost);

            // Event Listeners para o Modal de Autentica√ß√£o
            document.getElementById('menu-login-button')?.addEventListener('click', () => toggleAuthModal(true));
            document.getElementById('close-auth-modal-button')?.addEventListener('click', () => toggleAuthModal(false));
            document.getElementById('show-register-form-button')?.addEventListener('click', showRegisterForm);
            document.getElementById('show-login-form-button')?.addEventListener('click', showLoginForm);
            document.getElementById('anonymous-login-button')?.addEventListener('click', signInAnonymouslyUser);
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);

            // Event Listeners para o Modal de Nome de Usu√°rio An√¥nimo
            document.getElementById('save-anonymous-username-button')?.addEventListener('click', saveAnonymousUsername);
            document.getElementById('close-username-modal-button')?.addEventListener('click', () => {
                document.getElementById('username-modal')?.classList.add('hidden');
                document.getElementById('anonymous-username-input').value = '';
            });

            // Event Listener para o bot√£o de Logout no menu hamb√∫rguer
            document.getElementById('menu-logout-button')?.addEventListener('click', handleLogout);
        });
    </script>
</body>
</html>