<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o Eclesi√°stica</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Firebase SDKs (ser√£o importados no final do body) -->
    
    <!-- Estilos Tailwind CSS para anima√ß√µes e utilit√°rios -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: block; /* Garante que o body n√£o interfere com posicionamento fixo */
        }
        @keyframes fade-in-down {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-down {
            animation: fade-in-down 0.8s ease-out forwards;
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.8s ease-out forwards;
            animation-delay: 0.2s;
        }
        .hidden {
            display: none;
        }
        .notification-transition {
            transition: opacity 0.5s ease-in-out;
        }
        /* Estilos para o modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        /* Anima√ß√£o de carregamento (spinner) */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1; /* Cor do spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para o menu hamb√∫rguer */
        .hamburger-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 256px; /* Largura do menu */
            height: 100%;
            background-color: #1f2937; /* bg-gray-800 */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50; /* Acima de outros conte√∫dos */
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .hamburger-menu.open {
            transform: translateX(0);
        }

        .hamburger-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40; /* Abaixo do menu, mas acima do conte√∫do principal */
            display: none;
        }
        .hamburger-menu-overlay.open {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 p-4 relative">

    <!-- Mensagem de Carregamento -->
    <div id="loading-message" class="flex items-center justify-center min-h-screen bg-gray-100 absolute inset-0 z-10">
        <p class="text-xl text-gray-700">Carregando aplica√ß√£o...</p>
    </div>

    <!-- Barra de Notifica√ß√µes -->
    <div id="notification-bar" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-green-500 text-white text-center py-3 rounded-b-lg shadow-lg z-50 opacity-0 notification-transition hidden">
        <!-- Mensagens de notifica√ß√£o aparecer√£o aqui -->
    </div>

    <!-- Cabe√ßalho -->
    <header id="main-header" class="w-full max-w-4xl mx-auto bg-orange-600 text-white p-4 rounded-xl shadow-lg flex justify-between items-center mb-4 z-20 animate-fade-in-down hidden">
        <h1 class="text-3xl font-bold">Conex√£o Eclesi√°stica</h1>
        <div class="flex items-center space-x-4">
            <!-- Perfil do Usu√°rio no Cabe√ßalho -->
            <div id="user-profile-header" class="flex items-center space-x-2">
                <img id="profile-avatar" class="w-10 h-10 rounded-full border-2 border-white hidden" src="https://placehold.co/40x40/cccccc/000000?text=üë§" alt="Avatar do Usu√°rio">
                <span id="user-name-display" class="text-lg font-semibold">Visitante</span>
            </div>
            
            <!-- √çcone do Menu Hamb√∫rguer -->
            <button id="hamburger-icon" class="flex flex-col justify-around w-8 h-8 bg-orange-700 p-1 rounded-md cursor-pointer" onclick="window.toggleHamburgerMenu()">
                <span class="block h-0.5 bg-white rounded-full"></span>
                <span class="block h-0.5 bg-white rounded-full"></span>
                <span class="block h-0.5 bg-white rounded-full"></span>
            </button>
        </div>
    </header>

    <!-- Menu Hamb√∫rguer (Off-canvas) -->
    <nav id="hamburger-menu" class="hamburger-menu">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Menu</h2>
            <button id="close-hamburger-menu" class="text-white hover:text-gray-300" onclick="window.toggleHamburgerMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <ul class="flex flex-col space-y-4">
            <li>
                <button id="menu-admin-button" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300" onclick="window.handleAdminClick(); window.toggleHamburgerMenu()">
                    Administrador
                </button>
            </li>
            <li>
                <button id="menu-bible-button" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300" onclick="window.handleBibleClick(); window.toggleHamburgerMenu()">
                    B√≠blia
                </button>
            </li>
            <li id="menu-login-item">
                <button id="menu-login-button" class="w-full text-left bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300" onclick="window.toggleAuthModal(true); window.toggleHamburgerMenu()">
                    Login
                </button>
            </li>
            <li id="menu-logout-item" class="hidden">
                <button id="menu-logout-button" class="w-full text-left bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300" onclick="handleLogout(); window.toggleHamburgerMenu()">
                    Logout
                </button>
            </li>
        </ul>
    </nav>
    <div id="hamburger-menu-overlay" class="hamburger-menu-overlay" onclick="window.toggleHamburgerMenu()"></div>


    <!-- Conte√∫do da Aplica√ß√£o Principal (inicialmente oculto) -->
    <div id="app-content" class="hidden bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl mx-auto text-center">
        <p class="text-xl text-gray-700 mb-8 animate-fade-in-up">
            Bem-vindo(a)! Sua plataforma de intera√ß√£o e estudo.
        </p>

        <!-- Exibe o ID do usu√°rio para fins de depura√ß√£o e colabora√ß√£o -->
        <p class="text-sm text-gray-500 mb-6">
            Seu ID de Usu√°rio: <span id="user-id-display" class="font-mono bg-gray-100 px-2 py-1 rounded-md text-purple-600 break-all"></span>
        </p>

        <!-- Se√ß√£o de Posts -->
        <div class="mt-8 bg-blue-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-blue-700 mb-4">Mural de Not√≠cias e Posts</h2>
            <div id="posts-container" class="h-64 overflow-y-auto border border-gray-300 rounded-lg p-4 mb-4 bg-white shadow-sm">
                <!-- Posts ser√£o carregados aqui pelo JavaScript -->
            </div>
            <!-- Se√ß√£o para adicionar posts, inicialmente oculta -->
            <div id="add-post-section" class="flex gap-2 hidden">
                <textarea
                    id="new-post-content-textarea"
                    placeholder="Escreva seu post aqui..."
                    rows="3"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                ></textarea>
                <button
                    id="add-post-button"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-md self-end"
                >
                    Publicar
                </button>
            </div>
        </div>
    </div>

    <!-- Nova Tela Exclusiva para a B√≠blia -->
    <div id="bible-screen" class="hidden fixed inset-0 bg-gradient-to-br from-green-100 to-teal-200 flex flex-col items-center justify-start p-4 z-30 overflow-y-auto">
        <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 text-center relative">
            <button id="close-bible-screen-button" onclick="window.toggleBibleScreen()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-3xl font-bold text-center text-teal-700 mb-6">Central B√≠blica üìñ‚ú®</h2>
            <p class="text-gray-700 mb-8">Explore as escrituras e ferramentas de estudo.</p>

            <!-- Se√ß√£o de Estudo B√≠blico Inteligente -->
            <div class="mt-8 bg-green-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-bold text-green-700 mb-4">Estudo B√≠blico Inteligente</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <textarea
                        id="bible-question-input"
                        placeholder="Pergunte sobre um vers√≠culo, tema ou conceito b√≠blico (ex: 'Explique Jo√£o 3:16', 'O que √© a Gra√ßa de Deus?')"
                        rows="4"
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y"
                    ></textarea>
                    <button
                        id="generate-bible-study-button"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300 ease-in-out shadow-md self-end md:self-auto"
                    >
                        Gerar Estudo
                    </button>
                </div>
                <div id="bible-loading-indicator" class="hidden flex justify-center items-center py-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Gerando resposta...</p>
                </div>
                <div id="bible-response-area" class="bg-white border border-gray-300 rounded-lg p-4 text-left min-h-[100px] overflow-y-auto text-gray-800">
                    <p class="text-gray-500 italic">Sua resposta ser√° exibida aqui.</p>
                </div>
            </div>

            <!-- Se√ß√£o de Gerador de Ora√ß√µes Personalizadas -->
            <div class="mt-8 bg-purple-100 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-bold text-purple-700 mb-4">Gerador de Ora√ß√µes Personalizadas</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <textarea
                        id="prayer-topic-input"
                        placeholder="Descreva o tema da sua ora√ß√£o (ex: 'gratid√£o pela fam√≠lia', 'for√ßa em tempos dif√≠ceis', 'sabedoria para decis√µes')"
                        rows="4"
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-700 resize-y"
                    ></textarea>
                    <button
                        id="generate-prayer-button"
                        class="bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-800 transition duration-300 ease-in-out shadow-md self-end md:self-auto"
                    >
                        Gerar Ora√ß√£o
                    </button>
                </div>
                <div id="prayer-loading-indicator" class="hidden flex justify-center items-center py-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Gerando ora√ß√£o...</p>
                </div>
                <div id="prayer-response-area" class="bg-white border border-gray-300 rounded-lg p-4 text-left min-h-[100px] overflow-y-auto text-gray-800">
                    <p class="text-gray-500 italic">Sua ora√ß√£o personalizada ser√° exibida aqui.</p>
                </div>
            </div>

            <!-- Se√ß√£o de Leitura B√≠blica -->
            <div class="mt-8 bg-yellow-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-bold text-yellow-700 mb-4">Leitura B√≠blica</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="bible-book-select" class="block text-gray-700 text-sm font-bold mb-2 text-left">Livro:</label>
                        <select id="bible-book-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-yellow-500">
                            <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="bible-version-select" class="block text-gray-700 text-sm font-bold mb-2 text-left">Vers√£o:</label>
                        <select id="bible-version-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-yellow-500">
                            <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="bible-chapter-input" class="block text-gray-700 text-sm font-bold mb-2 text-left">Cap√≠tulo:</label>
                        <input type="number" id="bible-chapter-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-yellow-500" placeholder="23" value="1">
                    </div>
                    <div>
                        <label for="bible-verses-input" class="block text-gray-700 text-sm font-bold mb-2 text-left">Vers√≠culos (opcional, ex: 1-3 ou 5):</label>
                        <input type="text" id="bible-verses-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-yellow-500" placeholder="1-6">
                    </div>
                </div>
                <button
                    id="fetch-bible-verse-button"
                    class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-700 transition duration-300 ease-in-out shadow-md w-full md:w-auto"
                >
                    Buscar Vers√≠culo(s)
                </button>
                <div id="bible-verse-loading-indicator" class="hidden flex justify-center items-center py-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Buscando vers√≠culo(s)...</p>
                </div>
                <div id="bible-verse-display-area" class="bg-white border border-gray-300 rounded-lg p-4 text-left min-h-[100px] overflow-y-auto text-gray-800 mt-4">
                    <p class="text-gray-500 italic">O vers√≠culo ou passagem b√≠blica aparecer√° aqui.</p>
                </div>
            </div>

            <!-- Se√ß√£o de Busca na B√≠blia por Palavra-chave -->
            <div class="mt-8 bg-red-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Buscar na B√≠blia por Palavra-chave</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input
                        type="text"
                        id="bible-search-input"
                        placeholder="Digite uma palavra ou frase para buscar (ex: 'amor', 'f√©', 'salva√ß√£o')"
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                    <button
                        id="search-bible-button"
                        class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300 ease-in-out shadow-md self-end md:self-auto"
                    >
                        Buscar
                    </button>
                </div>
                <div id="bible-search-loading-indicator" class="hidden flex justify-center items-center py-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Buscando...</p>
                </div>
                <div id="bible-search-results-area" class="bg-white border border-gray-300 rounded-lg p-4 text-left min-h-[100px] overflow-y-auto text-gray-800">
                    <p class="text-gray-500 italic">Os resultados da busca aparecer√£o aqui.</p>
                </div>
            </div>

            <button class="mt-8 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg" onclick="window.toggleBibleScreen()">Voltar para o In√≠cio</button>
        </div>
    </div>

    <!-- Bot√£o para alternar o chat flutuante -->
    <button id="toggle-floating-chat-button" class="fixed bottom-4 right-4 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-lg z-50 transition duration-300 text-2xl font-bold hidden">
        üí¨
    </button>

    <!-- Cont√™iner do Chat Flutuante (inicialmente oculto) -->
    <div id="floating-chat-container" class="hidden fixed bottom-20 right-4 w-80 h-[400px] bg-white rounded-lg shadow-2xl flex flex-col z-40 overflow-hidden">
        <div class="bg-purple-700 text-white p-3 flex justify-between items-center rounded-t-lg">
            <h3 class="text-lg font-bold">Chat R√°pida</h3>
            <button id="close-floating-chat-button" onclick="window.toggleFloatingChat()" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="floating-messages-container" class="flex-grow overflow-y-auto p-4 bg-gray-50">
            <!-- Mensagens do chat flutuante ser√£o carregadas aqui -->
        </div>
        <div class="p-4 border-t border-gray-200 flex gap-2">
            <input
                type="text"
                id="floating-new-message-input"
                placeholder="Digite sua mensagem..."
                class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
            />
            <button
                id="floating-send-message-button"
                class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 ease-in-out shadow-md"
            >
                Enviar
            </button>
        </div>
    </div>

    <!-- Modal de Autentica√ß√£o (Login/Registro) -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="flex justify-center mb-6">
                <button id="show-login-form-button" class="px-4 py-2 text-lg font-semibold border-b-2 border-purple-600 text-purple-600 focus:outline-none">Login</button>
                <button id="show-register-form-button" class="px-4 py-2 text-lg font-semibold border-b-2 border-transparent text-gray-500 hover:text-purple-600 focus:outline-none">Registrar</button>
            </div>

            <!-- Formul√°rio de Login -->
            <form id="login-form" class="space-y-4">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Entrar</h2>
                <div>
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2 text-left">Email:</label>
                    <input type="email" id="login-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Senha:</label>
                    <input type="password" id="login-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Entrar
                </button>
                <div class="text-center mt-4">
                    <p class="text-gray-600">ou</p>
                    <button type="button" id="anonymous-login-button" class="mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                        Entrar como Convidado (An√¥nimo)
                    </button>
                </div>
            </form>

            <!-- Formul√°rio de Registro -->
            <form id="register-form" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Registrar</h2>
                <div>
                    <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2 text-left">Email:</label>
                    <input type="email" id="register-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <div>
                    <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Senha:</label>
                    <input type="password" id="register-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <div>
                    <label for="register-confirm-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Confirmar Senha:</label>
                    <input type="password" id="register-confirm-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-first-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Nome:</label>
                        <input type="text" id="register-first-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div>
                        <label for="register-last-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Sobrenome:</label>
                        <input type="text" id="register-last-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                    </div>
                </div>
                <div>
                    <label for="register-dob" class="block text-gray-700 text-sm font-bold mb-2 text-left">Data de Nascimento:</label>
                    <input type="date" id="register-dob" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div>
                    <label for="register-gender" class="block text-gray-700 text-sm font-bold mb-2 text-left">G√™nero:</label>
                    <select id="register-gender" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Selecione</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="register-phone" class="block text-gray-700 text-sm font-bold mb-2 text-left">Telefone:</label>
                    <input type="tel" id="register-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-street" class="block text-gray-700 text-sm font-bold mb-2 text-left">Rua/Avenida:</label>
                        <input type="text" id="register-street" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-city" class="block text-gray-700 text-sm font-bold mb-2 text-left">Cidade:</label>
                        <input type="text" id="register-city" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-state" class="block text-gray-700 text-sm font-bold mb-2 text-left">Estado:</label>
                        <input type="text" id="register-state" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-zip" class="block text-gray-700 text-sm font-bold mb-2 text-left">CEP:</label>
                        <input type="text" id="register-zip" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label for="register-church-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Nome da Igreja (Opcional):</label>
                    <input type="text" id="register-church-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="register-church-role" class="block text-gray-700 text-sm font-bold mb-2 text-left">Fun√ß√£o na Igreja:</label>
                    <select id="register-church-role" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Selecione</option>
                        <option value="membro">Membro</option>
                        <option value="lider">L√≠der</option>
                        <option value="voluntario">Volunt√°rio</option>
                        <option value="pastor">Pastor</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="register-terms" class="mr-2 leading-tight" required>
                    <label for="register-terms" class="text-sm text-gray-700">Eu concordo com os <a href="#" class="text-purple-600 hover:underline">Termos e Condi√ß√µes</a></label>
                </div>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Registrar
                </button>
            </form>
        </div>
    </div>

    <!-- Tela de Administrador (agora uma div em tela cheia) -->
    <div id="admin-screen" class="hidden fixed inset-0 bg-gray-100 flex flex-col items-center justify-start p-4 z-30 overflow-y-auto">
        <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 text-center relative">
            <button id="close-admin-screen-button" onclick="window.toggleAdminScreen()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-3xl font-bold text-center text-orange-600 mb-6">Painel de Administra√ß√£o</h2>

            <div id="admin-content" class="text-center">
                <!-- Conte√∫do do painel de administra√ß√£o ser√° carregado aqui -->
            </div>
        </div>
    </div>

    <!-- Novo Modal para Inserir Nome de Usu√°rio An√¥nimo -->
    <div id="username-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm relative text-center">
            <button id="close-username-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Qual √© o seu nome, Convidado?</h2>
            <input type="text" id="anonymous-username-input" placeholder="Digite seu nome" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500 mb-4" required>
            <button id="save-anonymous-username-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                Salvar Nome
            </button>
        </div>
    </div>

    <!-- Novo Rodap√© -->
    <footer id="main-footer" class="w-full max-w-4xl mx-auto bg-gray-800 text-white p-4 rounded-xl shadow-lg text-center mt-8 hidden">
        <p class="text-sm">&copy; 2025 Conex√£o Eclesi√°stica. Todos os direitos reservados.</p>
        <p class="text-xs mt-2">Desenvolvido com F√© e Tecnologia.</p>
    </footer>

    <script type="module">
        // Importa os m√≥dulos necess√°rios do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Vari√°veis globais para Firebase e dados do usu√°rio
        let db;
        let auth;
        let userId = null;
        let userName = null; // Novo para armazenar o nome do usu√°rio
        let isAuthReady = false;
        let analytics;

        // Configura√ß√µes do Firebase (fornecidas pelo usu√°rio)
        const firebaseConfig = {
            apiKey: "AIzaSyBfFQ0wZIe1WY0Lw3L0Rlr97UrnnSydurM", // Chave de API do Firebase
            authDomain: "conexao-eclesiastica.firebaseapp.com",
            databaseURL: "https://conexao-eclesiastica-default-rtdb.firebaseio.com", // Adicionado
            projectId: "conexao-eclesiastica",
            storageBucket: "conexao-eclesiastica.firebasestorage.app",
            messagingSenderId: "1009771043961",
            appId: "1:1009771043961:web:6a8d829618f0b0f8a508a8",
            measurementId: "G-W0701VYFK9"
        };
        const appId = firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Lista de livros da B√≠blia (fornecida pelo usu√°rio)
        const bibleBooks = [
            { abbrev: { pt: "gn", en: "gn" }, name: "G√™nesis", author: "Mois√©s", chapters: 50, group: "Pentateuco", testament: "VT" },
            { abbrev: { pt: "ex", en: "ex" }, name: "√äxodo", author: "Mois√©s", chapters: 40, group: "Pentateuco", testament: "VT" },
            { abbrev: { pt: "lv", en: "lv" }, name: "Lev√≠tico", author: "Mois√©s", chapters: 27, group: "Pentateuco", testament: "VT" },
            { abbrev: { pt: "nm", en: "nm" }, name: "N√∫meros", author: "Mois√©s", chapters: 36, group: "Pentateuco", testament: "VT" },
            { abbrev: { pt: "dt", en: "dt" }, name: "Deuteron√¥mio", author: "Mois√©s", chapters: 34, group: "Pentateuco", testament: "VT" },
            { abbrev: { pt: "js", en: "js" }, name: "Josu√©", author: "Josu√©", chapters: 24, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "jz", en: "jd" }, name: "Ju√≠zes", author: "Samuel", chapters: 21, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "rt", en: "rt" }, name: "Rute", author: "Samuel", chapters: 4, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "1sm", en: "1sm" }, name: "1 Samuel", author: "Samuel", chapters: 31, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "2sm", en: "2sm" }, name: "2 Samuel", author: "Nat√£ e Gade", chapters: 24, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "1rs", en: "1ki" }, name: "1 Reis", author: "Jeremias", chapters: 22, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "2rs", en: "2ki" }, name: "2 Reis", author: "Jeremias", chapters: 25, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "1cr", en: "1ch" }, name: "1 Cr√¥nicas", author: "Esdras", chapters: 29, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "2cr", en: "2ch" }, name: "2 Cr√¥nicas", author: "Esdras", chapters: 36, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "ed", en: "ezr" }, name: "Esdras", author: "Esdras", chapters: 10, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "ne", en: "ne" }, name: "Neemias", author: "Neemias", chapters: 13, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "et", en: "et" }, name: "Ester", author: "Desconhecido", chapters: 10, group: "Hist√≥ricos", testament: "VT" },
            { abbrev: { pt: "jo", en: "job" }, name: "J√≥", author: "Desconhecido", chapters: 42, group: "Po√©ticos", testament: "VT" },
            { abbrev: { pt: "sl", en: "ps" }, name: "Salmos", author: "David, Mois√©s, Salom√£o", chapters: 150, group: "Po√©ticos", testament: "VT" },
            { abbrev: { pt: "pv", en: "pr" }, name: "Prov√©rbios", author: "Salom√£o", chapters: 31, group: "Po√©ticos", testament: "VT" },
            { abbrev: { pt: "ec", en: "ec" }, name: "Eclesiastes", author: "Salom√£o", chapters: 12, group: "Po√©ticos", testament: "VT" },
            { abbrev: { pt: "ct", en: "so" }, name: "Cantares de Salom√£o", author: "Salom√£o", chapters: 8, group: "Po√©ticos", testament: "VT" },
            { abbrev: { pt: "is", en: "is" }, name: "Isa√≠as", author: "Isa√≠as", chapters: 66, group: "Profetas Maiores", testament: "VT" },
            { abbrev: { pt: "jr", en: "jr" }, name: "Jeremias", chapters: 52, group: "Profetas Maiores", testament: "VT" },
            { abbrev: { pt: "lm", en: "la" }, name: "Lamenta√ß√µes de Jeremias", author: "Jeremias", chapters: 5, group: "Profetas Maiores", testament: "VT" },
            { abbrev: { pt: "ez", en: "ez" }, name: "Ezequiel", author: "Ezequiel", chapters: 48, group: "Profetas Maiores", testament: "VT" },
            { abbrev: { pt: "dn", en: "dn" }, name: "Daniel", author: "Daniel", chapters: 12, group: "Profetas Maiores", testament: "VT" },
            { abbrev: { pt: "os", en: "ho" }, name: "Os√©ias", author: "Os√©ias", chapters: 14, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "jl", en: "jl" }, name: "Joel", author: "Joel", chapters: 3, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "am", en: "am" }, name: "Am√≥s", author: "Am√≥s", chapters: 9, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "ob", en: "ob" }, name: "Obadias", author: "Obadias", chapters: 1, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "jn", en: "jo" }, name: "Jonas", author: "Jonas", chapters: 4, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "mq", en: "mi" }, name: "Miqu√©ias", author: "Miqu√©ias", chapters: 7, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "na", en: "na" }, name: "Naum", author: "Naum", chapters: 3, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "hc", en: "hb" }, name: "Habacuque", author: "Habacuque", chapters: 3, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "sf", en: "zp" }, name: "Sofonias", author: "Sofonias", chapters: 3, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "ag", en: "hg" }, name: "Ageu", author: "Ageu", chapters: 2, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "zc", en: "zc" }, name: "Zacarias", author: "Zacarias", chapters: 14, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "ml", en: "ml" }, name: "Malaquias", author: "Malaquias", chapters: 4, group: "Profetas Menores", testament: "VT" },
            { abbrev: { pt: "mt", en: "mt" }, name: "Mateus", author: "Mateus", chapters: 28, group: "Evangelhos", testament: "NT" },
            { abbrev: { pt: "mc", en: "mk" }, name: "Marcos", author: "Marcos", chapters: 16, group: "Evangelhos", testament: "NT" },
            { abbrev: { pt: "lc", en: "lk" }, name: "Lucas", author: "Lucas", chapters: 24, group: "Evangelhos", testament: "NT" },
            { abbrev: { pt: "jo", en: "jn" }, name: "Jo√£o", author: "Jo√£o", chapters: 21, group: "Evangelhos", testament: "NT" },
            { abbrev: { pt: "at", en: "act" }, name: "Atos dos Ap√≥stolos", author: "Lucas", chapters: 28, group: "Hist√≥ricos", testament: "NT" },
            { abbrev: { pt: "rm", en: "rm" }, name: "Romanos", author: "Paulo", chapters: 16, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "1co", en: "1co" }, name: "1 Cor√≠ntios", author: "Paulo", chapters: 16, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "2co", en: "2co" }, name: "2 Cor√≠ntios", author: "Paulo", chapters: 13, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "gl", en: "gl" }, name: "G√°latas", author: "Paulo", chapters: 6, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "ef", en: "ep" }, name: "Ef√©sios", author: "Paulo", chapters: 6, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "fp", en: "ph" }, name: "Filipenses", author: "Paulo", chapters: 4, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "cl", en: "cl" }, name: "Colossenses", author: "Paulo", chapters: 4, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "1ts", en: "1th" }, name: "1 Tessalonicenses", author: "Paulo", chapters: 5, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "2ts", en: "2th" }, name: "2 Tessalonicenses", author: "Paulo", chapters: 3, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "1tm", en: "1tm" }, name: "1 Tim√≥teo", author: "Paulo", chapters: 6, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "2tm", en: "2tm" }, name: "2 Tim√≥teo", author: "Paulo", chapters: 4, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "tt", en: "tt" }, name: "Tito", author: "Paulo", chapters: 3, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "fm", en: "phm" }, name: "Filemom", author: "Paulo", chapters: 1, group: "Cartas Paulinas", testament: "NT" },
            { abbrev: { pt: "hb", en: "heb" }, name: "Hebreus", author: "Desconhecido", chapters: 13, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "tg", en: "jas" }, name: "Tiago", author: "Tiago", chapters: 5, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "1pe", en: "1pe" }, name: "1 Pedro", author: "Pedro", chapters: 5, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "2pe", en: "2pe" }, name: "2 Pedro", author: "Pedro", chapters: 3, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "1jo", en: "1jn" }, name: "1 Jo√£o", author: "Jo√£o", chapters: 5, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "2jo", en: "2jn" }, name: "2 Jo√£o", author: "Jo√£o", chapters: 1, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "3jo", en: "3jn" }, name: "3 Jo√£o", author: "Jo√£o", chapters: 1, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "jd", en: "jud" }, name: "Judas", author: "Judas", chapters: 1, group: "Cartas Gerais", testament: "NT" },
            { abbrev: { pt: "ap", en: "re" }, name: "Apocalipse", author: "Jo√£o", chapters: 22, group: "Prof√©tico", testament: "NT" }
        ];

        // Lista de vers√µes da B√≠blia (fornecida pelo usu√°rio)
        const bibleVersions = [
            { version: "acf", verses: 31106 },
            { version: "apee", verses: 30975 },
            { version: "bbe", verses: 31104 },
            { version: "nvi", verses: 31103 } // Adicionei NVI para que possa ser selecionada
        ];

        // Dados mock para configura√ß√µes da aplica√ß√£o
        let appSettings = {
            welcomeMessage: "Bem-vindo(a) √† Conex√£o Eclesi√°stica! Que a paz de Deus esteja com voc√™.",
            defaultChatMessage: "Ol√° a todos! Compartilhem suas b√™n√ß√£os e ora√ß√µes.",
            allowAnonymousPosting: false, // Por padr√£o, an√¥nimos n√£o podem postar
            publicChatEnabled: true,
            maintenanceMode: false
        };


        // Fun√ß√£o para inicializar o Firebase e configurar a autentica√ß√£o
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                // Listener para mudan√ßas no estado de autentica√ß√£o
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usu√°rio autenticado:", userId);

                        // Tenta buscar o nome do usu√°rio no perfil
                        const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'details');
                        const userProfileSnap = await getDoc(userProfileRef);
                        if (userProfileSnap.exists() && userProfileSnap.data().firstName) {
                            userName = userProfileSnap.data().firstName;
                            document.getElementById('user-name-display').textContent = userName; // Atualiza o nome no cabe√ßalho
                            document.getElementById('profile-avatar').classList.remove('hidden'); // Mostra o avatar
                            document.getElementById('user-id-display').textContent = `${userName} (${userId.substring(0, 8)}...)`;
                        } else {
                            userName = null; // Reseta o nome se n√£o encontrado
                            document.getElementById('user-name-display').textContent = user.isAnonymous ? 'Convidado' : 'Usu√°rio'; // Exibe "Convidado" ou "Usu√°rio"
                            document.getElementById('profile-avatar').classList.add('hidden'); // Esconde o avatar para visitantes
                            document.getElementById('user-id-display').textContent = user.isAnonymous ? `${userId} (An√¥nimo)` : userId;
                        }
                        
                        // Os bot√µes de login/logout no cabe√ßalho principal foram movidos para o menu hamb√∫rguer
                        // const loginButton = document.getElementById('login-button');
                        // if (loginButton) loginButton.classList.add('hidden');
                        // const logoutButton = document.getElementById('logout-button');
                        // if (logoutButton) logoutButton.classList.remove('hidden');
                        
                        const addPostSection = document.getElementById('add-post-section');
                        if (user.isAnonymous) {
                            if (addPostSection) addPostSection.classList.add('hidden');
                        } else {
                            if (addPostSection) addPostSection.classList.remove('hidden');
                        }

                        // Atualiza visibilidade dos bot√µes no menu hamb√∫rguer
                        const menuLoginItem = document.getElementById('menu-login-item');
                        const menuLogoutItem = document.getElementById('menu-logout-item');
                        if (menuLoginItem) menuLoginItem.classList.add('hidden');
                        if (menuLogoutItem) menuLogoutItem.classList.remove('hidden');

                    } else {
                        userId = null;
                        userName = null; // Reseta o nome ao deslogar
                        console.log("Usu√°rio n√£o autenticado.");
                        const userIdDisplay = document.getElementById('user-id-display');
                        if (userIdDisplay) userIdDisplay.textContent = 'N√£o dispon√≠vel';
                        const userNameDisplay = document.getElementById('user-name-display');
                        if (userNameDisplay) userNameDisplay.textContent = 'Visitante'; // Define como Visitante
                        const profileAvatar = document.getElementById('profile-avatar');
                        if (profileAvatar) profileAvatar.classList.add('hidden'); // Esconde o avatar para visitantes
                        
                        // Os bot√µes de login/logout no cabe√ßalho principal foram movidos para o menu hamb√∫rguer
                        // const loginButton = document.getElementById('login-button');
                        // if (loginButton) loginButton.classList.remove('hidden');
                        // const logoutButton = document.getElementById('logout-button');
                        // if (logoutButton) logoutButton.classList.add('hidden');
                        
                        const addPostSection = document.getElementById('add-post-section');
                        if (addPostSection) addPostSection.classList.add('hidden');

                        // Atualiza visibilidade dos bot√µes no menu hamb√∫rguer
                        const menuLoginItem = document.getElementById('menu-login-item');
                        const menuLogoutItem = document.getElementById('menu-logout-item');
                        if (menuLoginItem) menuLoginItem.classList.remove('hidden');
                        if (menuLogoutItem) menuLogoutItem.classList.add('hidden');


                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Autenticado com token personalizado.");
                            }
                            // N√£o h√° mais fallback para signInAnonymously aqui, o usu√°rio precisar√° fazer login ou registrar-se explicitamente.
                            catch (customTokenError) {
                                console.warn("Falha na autentica√ß√£o com token personalizado:", customTokenError);
                            }
                        }
                    }
                    isAuthReady = true;
                    // Move a exibi√ß√£o do app-content para aqui, ap√≥s a autentica√ß√£o
                    const loadingMessage = document.getElementById('loading-message');
                    const appContent = document.getElementById('app-content');
                    const headerElement = document.getElementById('main-header');
                    const toggleChatButtonElement = document.getElementById('toggle-floating-chat-button');
                    const footerElement = document.getElementById('main-footer');

                    if (loadingMessage) loadingMessage.classList.add('hidden');
                    if (appContent) appContent.classList.remove('hidden');
                    if (headerElement) headerElement.classList.remove('hidden');
                    if (toggleChatButtonElement) toggleChatButtonElement.classList.remove('hidden');
                    if (footerElement) footerElement.classList.remove('hidden');


                    setupChatListener();
                    setupPostsListener();
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) loadingMessage.textContent = 'Erro ao carregar a aplica√ß√£o.';
            }
        };

        // Fun√ß√£o para configurar o listener de mensagens do chat
        const setupChatListener = () => {
            if (db && userId && isAuthReady) {
                console.log("Configurando listener de mensagens para userId:", userId);
                const publicChatCollectionRef = collection(db, `artifacts/${appId}/public/data/chatMessages`);
                const q = query(publicChatCollectionRef); 

                onSnapshot(q, (snapshot) => {
                    const messagesContainer = document.getElementById('floating-messages-container');
                    if (!messagesContainer) return;

                    messagesContainer.innerHTML = '';
                    const fetchedMessages = [];
                    snapshot.docs.forEach(doc => {
                        fetchedMessages.push({ id: doc.id, ...doc.data() });
                    });
                    fetchedMessages.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                    if (fetchedMessages.length === 0) {
                        messagesContainer.innerHTML = '<p class="text-gray-500 italic">Nenhuma mensagem ainda. Seja o primeiro a enviar!</p>';
                    } else {
                        fetchedMessages.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.className = `mb-2 p-2 rounded-lg max-w-[80%] ${msg.userId === userId ? 'bg-purple-200 ml-auto text-right' : 'bg-gray-200 mr-auto text-left'}`;
                            // Exibe o nome do usu√°rio se dispon√≠vel, sen√£o o UID truncado
                            const senderDisplayName = msg.senderName || `Usu√°rio: ${msg.userId.substring(0, 8)}...`;
                            const timestampText = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : 'Data desconhecida';
                            msgDiv.innerHTML = `
                                <p class="text-sm font-semibold text-purple-800">${msg.userId === userId ? 'Voc√™' : senderDisplayName}</p>
                                <p class="text-gray-800">${msg.text}</p>
                                <span class="text-xs text-gray-500">${timestampText}</span>
                            `;
                            messagesContainer.appendChild(msgDiv);
                        });
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    console.log("Mensagens atualizadas:", fetchedMessages);
                }, (error) => {
                    console.error("Erro ao ouvir mensagens:", error);
                });
            }
        };

        // Fun√ß√£o para configurar o listener de posts
        const setupPostsListener = () => {
            if (db && userId && isAuthReady) {
                console.log("Configurando listener de posts para userId:", userId);
                const publicPostsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
                const q = query(publicPostsCollectionRef);

                onSnapshot(q, (snapshot) => {
                    const postsContainer = document.getElementById('posts-container');
                    if (!postsContainer) return;

                    postsContainer.innerHTML = '';
                    const fetchedPosts = [];
                    snapshot.docs.forEach(doc => {
                        fetchedPosts.push({ id: doc.id, ...doc.data() });
                    });
                    fetchedPosts.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                    if (fetchedPosts.length === 0) {
                        postsContainer.innerHTML = '<p class="text-gray-500 italic">Nenhum post ainda. Compartilhe algo!</p>';
                    } else {
                        fetchedPosts.forEach(post => {
                            const postDiv = document.createElement('div');
                            postDiv.className = "mb-4 p-3 border-b border-gray-200 last:border-b-0";
                            // Exibe o nome do usu√°rio se dispon√≠vel, sen√£o o UID truncado
                            const senderDisplayName = post.senderName || `Usu√°rio: ${post.userId.substring(0, 8)}...`;
                            const timestampText = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : 'Data desconhecida';
                            msgDiv.innerHTML = `
                                <p class="text-sm font-semibold text-blue-800">${post.userId === userId ? 'Voc√™' : senderDisplayName}</p>
                                <p class="text-gray-800 text-lg">${post.content}</p>
                                <span class="text-xs text-gray-500">${timestampText}</span>
                            `;
                            postsContainer.appendChild(postDiv);
                        });
                    }
                    postsContainer.scrollTop = postsContainer.scrollHeight;
                    console.log("Posts atualizadas:", fetchedPosts);
                }, (error) => {
                    console.error("Erro ao ouvir posts:", error);
                });
            }
        };

        const showNotification = (message, type = 'success') => {
            const notificationBar = document.getElementById('notification-bar');
            if (!notificationBar) return;

            notificationBar.textContent = message;
            notificationBar.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-gray-700');

            if (type === 'success') {
                notificationBar.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationBar.classList.add('bg-red-500');
            } else {
                notificationBar.classList.add('bg-gray-700');
            }

            notificationBar.classList.remove('opacity-0');
            notificationBar.classList.add('opacity-100');

            setTimeout(() => {
                notificationBar.classList.remove('opacity-100');
                notificationBar.classList.add('opacity-0');
                setTimeout(() => {
                    notificationBar.classList.add('hidden');
                }, 500);
            }, 3000);
        };

        const sendMessage = async () => {
            const newMessageInput = document.getElementById('floating-new-message-input');
            if (!newMessageInput) return;
            const newMessage = newMessageInput.value.trim();

            if (!db || !userId || !newMessage) {
                showNotification("Por favor, digite uma mensagem.", 'error');
                return;
            }
            try {
                const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/chatMessages`);
                await addDoc(chatCollectionRef, {
                    text: newMessage,
                    userId: userId,
                    senderName: userName || `An√¥nimo (${userId.substring(0,4)})`, // Adiciona o nome do remetente
                    timestamp: new Date(),
                });
                newMessageInput.value = '';
                showNotification("Mensagem enviada com sucesso!", 'success');
            } catch (error) {
                showNotification("Erro ao enviar mensagem.", 'error');
                console.error("Erro ao enviar mensagem:", error);
            }
        };

        const addPost = async () => {
            const newPostContentTextarea = document.getElementById('new-post-content-textarea');
            if (!newPostContentTextarea) return;
            const newPostContent = newPostContentTextarea.value.trim();

            if (!userId) {
                showNotification("Voc√™ precisa estar logado para postar.", 'error');
                return;
            }

            if (auth.currentUser && auth.currentUser.isAnonymous) {
                showNotification("Usu√°rios an√¥nimos n√£o podem criar posts. Por favor, registre-se ou fa√ßa login.", 'error');
                return;
            }

            if (!db || !newPostContent) {
                showNotification("Por favor, digite o conte√∫do do post.", 'error');
                return;
            }
            try {
                const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
                await addDoc(postsCollectionRef, {
                    content: newPostContent,
                    userId: userId,
                    senderName: userName, // Adiciona o nome do remetente
                    timestamp: new Date(),
                });
                newPostContentTextarea.value = '';
                showNotification("Post publicado com sucesso!", 'success');
            } catch (error) {
                showNotification("Erro ao publicar post.", 'error');
                console.error("Erro ao publicar post:", error);
            }
        };

        // Fun√ß√µes para o Modal de Autentica√ß√£o
        window.toggleAuthModal = (showLogin = true) => { // Tornada global
            const authModal = document.getElementById('auth-modal');
            if (!authModal) return;
            authModal.classList.toggle('hidden');
            
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (showLogin) {
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
            } else {
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
            }
        };

        const showLoginForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showLoginFormButton = document.getElementById('show-login-form-button');
            const showRegisterFormButton = document.getElementById('show-register-form-button');

            if (loginForm) loginForm.classList.remove('hidden');
            if (registerForm) registerForm.classList.add('hidden');
            
            if (showLoginFormButton) {
                showLoginFormButton.classList.add('border-purple-600', 'text-purple-600');
                showLoginFormButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
            if (showRegisterFormButton) {
                showRegisterFormButton.classList.remove('border-purple-600', 'text-purple-600');
                showRegisterFormButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
        };

        const showRegisterForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showLoginFormButton = document.getElementById('show-login-form-button');
            const showRegisterFormButton = document.getElementById('show-register-form-button');

            if (loginForm) loginForm.classList.add('hidden');
            if (registerForm) registerForm.classList.remove('hidden');
            
            if (showRegisterFormButton) {
                showRegisterFormButton.classList.add('border-purple-600', 'text-purple-600');
                showRegisterFormButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
            if (showLoginFormButton) {
                showLoginFormButton.classList.remove('border-purple-600', 'text-purple-600');
                showLoginFormButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
        };

        // Fun√ß√£o para login an√¥nimo e solicita√ß√£o de nome
        const signInAnonymouslyUser = async () => {
            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                showNotification("Login como convidado realizado com sucesso!", 'success');
                window.toggleAuthModal(false); // Fecha o modal de autentica√ß√£o

                const usernameModal = document.getElementById('username-modal');
                const anonymousUsernameInput = document.getElementById('anonymous-username-input');

                if (usernameModal) usernameModal.classList.remove('hidden');
                if (anonymousUsernameInput) anonymousUsernameInput.focus();

            } catch (error) {
                showNotification("Erro ao entrar como convidado. Tente novamente.", 'error');
                console.error("Erro no login an√¥nimo:", error);
            }
        };

        // Fun√ß√£o para salvar o nome do usu√°rio an√¥nimo
        const saveAnonymousUsername = async () => {
            const inputName = document.getElementById('anonymous-username-input').value.trim();
            if (!inputName) {
                showNotification("Por favor, digite um nome.", 'error');
                return;
            }

            if (auth.currentUser && db) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile`, 'details');
                    await setDoc(userProfileRef, {
                        firstName: inputName,
                        isAnonymousProfile: true, // Marca como perfil an√¥nimo
                        registeredAt: new Date(),
                    }, { merge: true }); // Usa merge para n√£o sobrescrever outros campos se existirem

                    userName = inputName; // Atualiza o nome global
                    document.getElementById('user-id-display').textContent = `${userName} (An√¥nimo)`;
                    showNotification("Nome salvo com sucesso!", 'success');
                    
                    const usernameModal = document.getElementById('username-modal');
                    const anonymousUsernameInput = document.getElementById('anonymous-username-input');
                    if (usernameModal) usernameModal.classList.add('hidden');
                    if (anonymousUsernameInput) anonymousUsernameInput.value = ''; // Limpa o campo
                } catch (error) {
                    showNotification("Erro ao salvar o nome.", 'error');
                    console.error("Erro ao salvar nome an√¥nimo:", error);
                }
            } else {
                showNotification("Erro: Usu√°rio n√£o autenticado ou DB n√£o dispon√≠vel.", 'error');
            }
        };


        const handleRegister = async (event) => {
            event.preventDefault();

            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const firstName = document.getElementById('register-first-name').value;
            const lastName = document.getElementById('register-last-name').value;
            const dob = document.getElementById('register-dob').value;
            const gender = document.getElementById('register-gender').value;
            const phone = document.getElementById('register-phone').value;
            const street = document.getElementById('register-street').value;
            const city = document.getElementById('register-city').value;
            const state = document.getElementById('register-state').value;
            const zip = document.getElementById('register-zip').value;
            const churchName = document.getElementById('register-church-name').value;
            const churchRole = document.getElementById('register-church-role').value;
            const termsAccepted = document.getElementById('register-terms').checked;

            if (password !== confirmPassword) {
                showNotification("As senhas n√£o coincidem.", 'error');
                return;
            }
            if (!termsAccepted) {
                showNotification("Voc√™ deve aceitar os termos e condi√ß√µes.", 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'details');
                await setDoc(userProfileRef, {
                    firstName: firstName,
                    lastName: lastName,
                    dob: dob,
                    gender: gender,
                    phone: phone,
                    address: {
                        street: street,
                        city: city,
                        state: state,
                        zip: zip,
                    },
                    churchName: churchName,
                    churchRole: churchRole,
                    registeredAt: new Date(),
                    isAnonymousProfile: false, // Marca como perfil n√£o an√¥nimo
                });

                showNotification("Registro e login bem-sucedidos!", 'success');
                window.toggleAuthModal(false); // Chamada corrigida
                document.getElementById('register-form').reset();
            }
            catch (error) {
                let errorMessage = "Erro ao registrar. Tente novamente.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este e-mail j√° est√° em uso.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Endere√ßo de e-mail inv√°lido.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                }
                showNotification(errorMessage, 'error');
                console.error("Erro no registro:", error);
            }
        };

        const handleLogin = async (event) => {
            event.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification("Login bem-sucedido!", 'success');
                window.toggleAuthModal(false); // Chamada corrigida
                document.getElementById('login-form').reset();
            } catch (error) {
                let errorMessage = "Erro ao fazer login. Verifique suas credenciais.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "E-mail ou senha inv√°lidos.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Endere√ßo de e-mail inv√°lido.";
                }
                showNotification(errorMessage, 'error');
                console.error("Erro no login:", error);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                showNotification("Logout realizado com sucesso!", 'info');
                console.log("Usu√°rio deslogado.");
            } catch (error) {
                showNotification("Erro ao fazer logout.", 'error');
                console.error("Erro no logout:", error);
            }
        };

        // Fun√ß√µes para a Tela de Administrador (agora uma div em tela cheia)
        window.toggleAdminScreen = () => {
            const adminScreen = document.getElementById('admin-screen');
            const appContent = document.getElementById('app-content');
            const header = document.getElementById('main-header'); // Usando ID
            const floatingChatButton = document.getElementById('toggle-floating-chat-button');
            const footer = document.getElementById('main-footer'); // Usando ID
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');


            if (adminScreen && appContent && header && floatingChatButton && footer && hamburgerMenu && hamburgerOverlay) { // Verifica se todos os elementos existem
                if (adminScreen.classList.contains('hidden')) {
                    // Entrando na tela de administra√ß√£o
                    appContent.classList.add('hidden');
                    header.classList.add('hidden');
                    floatingChatButton.classList.add('hidden');
                    footer.classList.add('hidden');
                    hamburgerMenu.classList.remove('open'); // Fecha o menu hamb√∫rguer se estiver aberto
                    hamburgerOverlay.classList.remove('open'); // Esconde o overlay
                    adminScreen.classList.remove('hidden');
                    window.loadAdminDashboard();
                } else {
                    // Saindo da tela de administra√ß√£o
                    adminScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    header.classList.remove('hidden');
                    floatingChatButton.classList.remove('hidden');
                    footer.classList.remove('hidden');
                }
            } else {
                console.error("Erro: Um ou mais elementos essenciais para alternar a tela de administra√ß√£o n√£o foram encontrados.");
                showNotification("Erro ao alternar tela de administra√ß√£o.", 'error');
            }
        };

        // Atribui handleAdminClick ao window para ser chamado pelo bot√£o "Administrador"
        window.handleAdminClick = () => {
            window.toggleAdminScreen();
        };

        // Nova fun√ß√£o para alternar a tela da B√≠blia
        window.toggleBibleScreen = () => {
            const bibleScreen = document.getElementById('bible-screen');
            const appContent = document.getElementById('app-content');
            const header = document.getElementById('main-header');
            const floatingChatButton = document.getElementById('toggle-floating-chat-button');
            const footer = document.getElementById('main-footer');
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');


            if (bibleScreen && appContent && header && floatingChatButton && footer && hamburgerMenu && hamburgerOverlay) {
                if (bibleScreen.classList.contains('hidden')) {
                    // Entrando na tela da B√≠blia
                    appContent.classList.add('hidden');
                    header.classList.add('hidden'); // Oculta o cabe√ßalho na tela da B√≠blia
                    floatingChatButton.classList.add('hidden'); // Oculta o bot√£o de chat
                    footer.classList.add('hidden'); // Oculta o rodap√©
                    hamburgerMenu.classList.remove('open'); // Fecha o menu hamb√∫rguer se estiver aberto
                    hamburgerOverlay.classList.remove('open'); // Esconde o overlay
                    bibleScreen.classList.remove('hidden');
                    // Opcional: recarregar dropdowns ou dados se necess√°rio
                    populateBibleBooksDropdown();
                    populateBibleVersionsDropdown();
                } else {
                    // Saindo da tela da B√≠blia
                    bibleScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    header.classList.remove('hidden'); // Mostra o cabe√ßalho
                    floatingChatButton.classList.remove('hidden'); // Mostra o bot√£o de chat
                    footer.classList.remove('hidden'); // Mostra o rodap√©
                }
            } else {
                console.error("Erro: Um ou mais elementos essenciais para alternar a tela da B√≠blia n√£o foram encontrados.");
                showNotification("Erro ao alternar tela da B√≠blia.", 'error');
            }
        };

        // Atribui handleBibleClick ao window para ser chamado pelo bot√£o "B√≠blia"
        window.handleBibleClick = () => {
            window.toggleBibleScreen();
        };

        // Fun√ß√£o para alternar o chat flutuante
        window.toggleFloatingChat = () => {
            const floatingChatContainer = document.getElementById('floating-chat-container');
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');

            if (!floatingChatContainer) return;

            floatingChatContainer.classList.toggle('hidden');
            // Fecha o menu hamb√∫rguer se estiver aberto ao abrir/fechar o chat
            if (hamburgerMenu && hamburgerMenu.classList.contains('open')) {
                hamburgerMenu.classList.remove('open');
                if (hamburgerOverlay) hamburgerOverlay.classList.remove('open');
            }
        };

        // Fun√ß√£o para alternar o menu hamb√∫rguer
        window.toggleHamburgerMenu = () => {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');
            const floatingChatContainer = document.getElementById('floating-chat-container');

            if (!hamburgerMenu || !hamburgerOverlay) return;

            hamburgerMenu.classList.toggle('open');
            hamburgerOverlay.classList.toggle('open');

            // Fecha o chat flutuante se estiver aberto ao abrir/fechar o menu hamb√∫rguer
            if (floatingChatContainer && !floatingChatContainer.classList.contains('hidden')) {
                floatingChatContainer.classList.add('hidden');
            }
        };


        window.loadAdminDashboard = () => {
            console.log("Carregando dashboard de administra√ß√£o...");
            const adminContent = document.getElementById('admin-content');
            if (!adminContent) {
                console.error("Elemento 'admin-content' n√£o encontrado.");
                return;
            }
            adminContent.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Vis√£o Geral do Administrador</h3>
                <p class="text-gray-700">Bem-vindo ao painel de administra√ß√£o. Selecione uma op√ß√£o para gerenciar:</p>
                <ul class="mt-4 space-y-2 text-left">
                    <li><button class="text-blue-600 hover:underline" onclick="window.showManageUsers()">Gerenciar Usu√°rios</button></li>
                    <li><button class="text-blue-600 hover:underline" onclick="window.showManagePosts()">Gerenciar Posts</button></li>
                    <li><button class="text-blue-600 hover:underline" onclick="window.showAppSettings()">Configura√ß√µes da Aplica√ß√£o</button></li>
                </ul>
                <button class="mt-8 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg" onclick="window.toggleAdminScreen()">Voltar para o In√≠cio</button>
            `;
        };

        window.showManageUsers = async () => {
            const adminContent = document.getElementById('admin-content');
            if (!adminContent) {
                console.error("Elemento 'admin-content' n√£o encontrado em showManageUsers.");
                return;
            }
            adminContent.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar Usu√°rios</h3>
                <div id="admin-users-loading" class="flex justify-center items-center py-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Carregando usu√°rios...</p>
                </div>
                <div id="admin-users-table-container" class="overflow-x-auto"></div>
                <button class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg" onclick="window.loadAdminDashboard()">Voltar</button>
            `;

            const usersTableContainer = document.getElementById('admin-users-table-container');
            const usersLoading = document.getElementById('admin-users-loading');

            // Simula√ß√£o de chamada API com headers
            try {
                if (usersLoading) usersLoading.classList.remove('hidden');
                // Simula um atraso de rede para demonstrar o carregamento
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                // Dados mock de usu√°rios com a nova estrutura simplificada
                const mockUsers = [
                    { id: 'user123', name: 'Jo√£o Silva', email: 'joao@example.com', token: 'eyJhbGciOiJIU...', notifications: true },
                    { id: 'user456', name: 'Maria Souza', email: 'maria@example.com', token: 'eyJhbGciOiJIU...', notifications: false },
                    { id: 'user789', name: 'Convidado_XYZ', email: 'anon1@example.com', token: 'eyJhbGciOiJIU...', notifications: true },
                    { id: 'user012', name: 'Pedro Alves', email: 'pedro@example.com', token: 'eyJhbGciOiJIU...', notifications: true },
                ];

                // Em um cen√°rio real, voc√™ faria uma requisi√ß√£o fetch para seu backend de administra√ß√£o:
                /*
                const token_do_administrador = await auth.currentUser.getIdToken();
                const response = await fetch('/api/admin/users', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token_do_administrador}` 
                    }
                });
                const users = await response.json();
                */

                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">ID (truncado)</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Nome</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Email</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Token (truncado)</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Notifica√ß√µes</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                mockUsers.forEach(user => {
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${user.id.substring(0, 8)}...</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${user.name}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${user.email}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${user.token.substring(0, 10)}...</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${user.notifications ? 'Sim' : 'N√£o'}</td>
                            <td class="py-2 px-4 border-b text-sm">
                                <button class="bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 mr-1">Editar</button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600">Excluir</button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                if (usersTableContainer) usersTableContainer.innerHTML = tableHtml;
                showNotification("Lista de usu√°rios carregada!", 'success');

            } catch (error) {
                if (usersTableContainer) usersTableContainer.innerHTML = `<p class="text-red-500">Erro ao carregar usu√°rios: ${error.message}</p>`;
                showNotification("Erro ao carregar usu√°rios.", 'error');
                console.error("Erro ao gerenciar usu√°rios:", error);
            } finally {
                if (usersLoading) usersLoading.classList.add('hidden');
            }
        };

        window.showManagePosts = async () => {
            const adminContent = document.getElementById('admin-content');
            if (!adminContent) {
                console.error("Elemento 'admin-content' n√£o encontrado em showManagePosts.");
                return;
            }
            adminContent.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar Posts</h3>
                <div id="admin-posts-loading" class="flex justify-center items-center py-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Carregando posts...</p>
                </div>
                <div id="admin-posts-table-container" class="overflow-x-auto"></div>
                <button class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg" onclick="window.loadAdminDashboard()">Voltar</button>
            `;

            const postsTableContainer = document.getElementById('admin-posts-table-container');
            const postsLoading = document.getElementById('admin-posts-loading');

            // Simula√ß√£o de chamada API com headers
            try {
                if (postsLoading) postsLoading.classList.remove('hidden');
                // Simula um atraso de rede
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                // Dados mock de posts
                const mockPosts = [
                    { id: 'postA1', author: 'Jo√£o Silva', content: 'Que dia aben√ßoado na igreja hoje!', timestamp: new Date().toLocaleString(), status: 'publicado' },
                    { id: 'postB2', author: 'Maria Souza', content: 'Vers√≠culo do dia: Salmos 23:1', timestamp: new Date().toLocaleString(), status: 'publicado' },
                    { id: 'postC3', author: 'Convidado_XYZ', content: 'Ol√° a todos!', timestamp: new Date().toLocaleString(), status: 'pendente' },
                ];

                // Em um cen√°rio real, voc√™ faria uma requisi√ß√£o fetch para seu backend de administra√ß√£o:
                /*
                const token_do_administrador = "eyJhbGciOiJIU..."; // Obtenha o token do usu√°rio administrador logado
                const response = await fetch('/api/admin/posts', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token_do_administrador}` // Token de autentica√ß√£o do administrador
                    }
                });
                const posts = await response.json();
                */

                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">ID (truncado)</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Autor</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Conte√∫do</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Data</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Status</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                mockPosts.forEach(post => {
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${post.id.substring(0, 8)}...</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${post.author}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800 truncate max-w-xs">${post.content}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${post.timestamp}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${post.status}</td>
                            <td class="py-2 px-4 border-b text-sm">
                                <button class="bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 mr-1">Editar</button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600">Excluir</button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                if (postsTableContainer) postsTableContainer.innerHTML = tableHtml;
                showNotification("Lista de posts carregada!", 'success');

            } catch (error) {
                if (postsTableContainer) postsTableContainer.innerHTML = `<p class="text-red-500">Erro ao carregar posts: ${error.message}</p>`;
                showNotification("Erro ao carregar posts.", 'error');
                console.error("Erro ao gerenciar posts:", error);
            } finally {
                if (postsLoading) postsLoading.classList.add('hidden');
            }
        };

        // Fun√ß√£o para exibir as configura√ß√µes da aplica√ß√£o
        window.showAppSettings = () => {
            const adminContent = document.getElementById('admin-content');
            if (!adminContent) {
                console.error("Elemento 'admin-content' n√£o encontrado em showAppSettings.");
                return;
            }
            adminContent.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Configura√ß√µes da Aplica√ß√£o</h3>
                <div class="bg-white p-6 rounded-lg shadow-inner text-left">
                    <div class="mb-4">
                        <label for="welcome-message-input" class="block text-gray-700 text-sm font-bold mb-2">Mensagem de Boas-vindas:</label>
                        <textarea id="welcome-message-input" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">${appSettings.welcomeMessage}</textarea>
                    </div>
                    <div class="mb-4">
                        <label for="default-chat-message-input" class="block text-gray-700 text-sm font-bold mb-2">Mensagem Padr√£o do Chat:</label>
                        <input type="text" id="default-chat-message-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" value="${appSettings.defaultChatMessage}">
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="allow-anonymous-posting-checkbox" class="mr-2 leading-tight" ${appSettings.allowAnonymousPosting ? 'checked' : ''}>
                        <label for="allow-anonymous-posting-checkbox" class="text-sm text-gray-700">Permitir Postagens de An√¥nimos (Aten√ß√£o: Requer ajuste nas Regras do Firestore)</label>
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="public-chat-enabled-checkbox" class="mr-2 leading-tight" ${appSettings.publicChatEnabled ? 'checked' : ''}>
                        <label for="public-chat-enabled-checkbox" class="text-sm text-gray-700">Chat P√∫blico Ativado</label>
                    </div>
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="maintenance-mode-checkbox" class="mr-2 leading-tight" ${appSettings.maintenanceMode ? 'checked' : ''}>
                        <label for="maintenance-mode-checkbox" class="text-sm text-gray-700">Modo de Manuten√ß√£o (Desabilita intera√ß√µes)</label>
                    </div>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 mr-2" onclick="window.saveAppSettings()">
                        Salvar Configura√ß√µes
                    </button>
                    <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg" onclick="window.loadAdminDashboard()">Voltar</button>
                </div>
            `;
        };

        // Fun√ß√£o para salvar as configura√ß√µes da aplica√ß√£o (simulado)
        window.saveAppSettings = () => {
            const welcomeMessageInput = document.getElementById('welcome-message-input');
            const defaultChatMessageInput = document.getElementById('default-chat-message-input');
            const allowAnonymousPostingCheckbox = document.getElementById('allow-anonymous-posting-checkbox');
            const publicChatEnabledCheckbox = document.getElementById('public-chat-enabled-checkbox');
            const maintenanceModeCheckbox = document.getElementById('maintenance-mode-checkbox');

            if (welcomeMessageInput) appSettings.welcomeMessage = welcomeMessageInput.value;
            if (defaultChatMessageInput) appSettings.defaultChatMessage = defaultChatMessageInput.value;
            if (allowAnonymousPostingCheckbox) appSettings.allowAnonymousPosting = allowAnonymousPostingCheckbox.checked;
            if (publicChatEnabledCheckbox) appSettings.publicChatEnabled = publicChatEnabledCheckbox.checked;
            if (maintenanceModeCheckbox) appSettings.maintenanceMode = maintenanceModeCheckbox.checked;

            showNotification("Configura√ß√µes salvas (simulado)!", 'success');
            console.log("Configura√ß√µes salvas:", appSettings);

            // Em um cen√°rio real, voc√™ enviaria esses dados para o seu backend:
            /*
            const token_do_administrador = await auth.currentUser.getIdToken();
            fetch('/api/admin/settings', {
                method: 'POST', // ou PUT
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token_do_administrador}`
                },
                body: JSON.stringify(appSettings)
            })
            .then(response => response.json())
            .then(data => {
                showNotification("Configura√ß√µes salvas com sucesso!", 'success');
                console.log("Configura√ß√µes salvas no backend:", data);
            })
            .catch(error => {
                showNotification("Erro ao salvar configura√ß√µes no backend.", 'error');
                console.error("Erro ao salvar configura√ß√µes:", error);
            });
            */
        };


        // Fun√ß√£o para chamar a API Gemini para estudo b√≠blico
        // Protege a chave Gemini em produ√ß√£o (exemplo did√°tico)
        const GEMINI_API_KEY = "AIzaSyAXSNFBenSCk7wWscAafWILt45vok8cnMU"; // Chave de API do Gemini fornecida pelo usu√°rio
        const generateBibleStudy = async () => {
            const bibleQuestionInput = document.getElementById('bible-question-input');
            const bibleResponseArea = document.getElementById('bible-response-area');
            const bibleLoadingIndicator = document.getElementById('bible-loading-indicator');
            const question = bibleQuestionInput.value.trim();

            if (!question) {
                showNotification("Por favor, digite sua pergunta sobre a B√≠blia.", 'error');
                return;
            }

            bibleResponseArea.textContent = '';
            showGlobalLoading(true);
            if (bibleLoadingIndicator) bibleLoadingIndicator.classList.remove('hidden');

            try {
                const prompt = `Explique o seguinte conceito ou vers√≠culo b√≠blico de forma clara e concisa, baseando-se em conhecimento b√≠blico: "${question}".`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = GEMINI_API_KEY;
                if (!apiKey) throw new Error("Chave Gemini n√£o definida. Configure window.GEMINI_API_KEY.");
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (bibleResponseArea) bibleResponseArea.textContent = text;
                    showNotification("Estudo b√≠blico gerado!", 'success');
                } else {
                    if (bibleResponseArea) bibleResponseArea.textContent = "N√£o foi poss√≠vel gerar uma resposta. Tente novamente.";
                    showNotification("Erro ao gerar estudo b√≠blico.", 'error');
                    console.error("Estrutura de resposta da API Gemini inesperada:", result);
                }
            } catch (error) {
                if (bibleResponseArea) bibleResponseArea.textContent = "Ocorreu um erro ao conectar com a IA. Tente novamente mais tarde.";
                showNotification("Erro na conex√£o com a IA.", 'error');
                console.error("Erro na chamada da API Gemini:", error);
            } finally {
                if (bibleLoadingIndicator) bibleLoadingIndicator.classList.add('hidden');
                showGlobalLoading(false);
            }
        };

        // Fun√ß√£o para buscar vers√≠culos b√≠blicos usando a API da B√≠blia Digital
        const fetchBibleVerse = async () => {
            const bookSelect = document.getElementById('bible-book-select');
            const versionSelect = document.getElementById('bible-version-select'); // Novo select de vers√£o
            const chapterInput = document.getElementById('bible-chapter-input');
            const versesInput = document.getElementById('bible-verses-input');
            const bibleVerseDisplayArea = document.getElementById('bible-verse-display-area');
            const bibleVerseLoadingIndicator = document.getElementById('bible-verse-loading-indicator');

            if (!bookSelect || !versionSelect || !chapterInput || !versesInput || !bibleVerseDisplayArea || !bibleVerseLoadingIndicator) return;


            const selectedBookAbbrevPt = bookSelect.value.trim();
            const selectedVersion = versionSelect.value.trim(); // Obt√©m a vers√£o selecionada
            const chapterNumber = chapterInput.value.trim();
            const versesRange = versesInput.value.trim();


            if (!selectedBookAbbrevPt || !chapterNumber || !selectedVersion) {
                showNotification("Por favor, selecione um livro, uma vers√£o e insira o cap√≠tulo.", 'error');
                return;
            }

            bibleVerseDisplayArea.innerHTML = '';
            bibleVerseLoadingIndicator.classList.remove('hidden');

            let apiUrl = `https://www.abibliadigital.com.br/api/verses/${selectedVersion}/${selectedBookAbbrevPt}/${chapterNumber}`;
            
            if (versesRange && !versesRange.includes('-')) {
                apiUrl += `/${versesRange}`;
            }

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (response.ok && data.verses && data.verses.length > 0) {
                    let versesToDisplay = data.verses;
                    
                    if (versesRange && versesRange.includes('-')) {
                        const [startVerse, endVerse] = versesRange.split('-').map(Number);
                        versesToDisplay = data.verses.filter(verse => verse.number >= startVerse && verse.number <= endVerse);
                    } else if (versesRange && !isNaN(Number(versesRange))) {
                        versesToDisplay = data.verses.filter(verse => verse.number === Number(versesRange));
                    }

                    if (versesToDisplay.length > 0) {
                        let formattedOutput = `
                            <h4 class="text-lg font-bold text-gray-800 mb-2">${data.book.name} ${data.chapter.number} (${data.version})</h4>
                        `;
                        versesToDisplay.forEach(verse => {
                            formattedOutput += `<p class="mb-1"><span class="font-semibold">${verse.number}.</span> ${verse.text}</p>`;
                        });
                        bibleVerseDisplayArea.innerHTML = formattedOutput;
                        showNotification("Vers√≠culo(s) encontrado(s)!", 'success');
                    } else {
                         bibleVerseDisplayArea.innerHTML = `<p class="text-red-500">Vers√≠culo(s) n√£o encontrado(s) no cap√≠tulo especificado. Verifique o intervalo.</p>`;
                         showNotification("Vers√≠culo(s) n√£o encontrado(s).", 'error');
                    }
                } else {
                    bibleVerseDisplayArea.innerHTML = `<p class="text-red-500">N√£o foi poss√≠vel encontrar o vers√≠culo. Verifique o livro, cap√≠tulo e vers√£o.</p>`;
                    showNotification("Vers√≠culo(s) n√£o encontrado(s).", 'error');
                    console.error("Erro na resposta da API da B√≠blia:", data);
                }
            } catch (error) {
                bibleVerseDisplayArea.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar o vers√≠culo. Verifique sua conex√£o ou tente novamente mais tarde.</p>`;
                showNotification("Erro na conex√£o com a API da B√≠blia.", 'error');
                console.error("Erro na chamada da API da B√≠blia:", error);
            } finally {
                bibleVerseLoadingIndicator.classList.add('hidden');
            }
        };

        // Fun√ß√£o para buscar vers√≠culos da B√≠blia por palavra-chave
        const searchBibleVerses = async () => {
            const searchInput = document.getElementById('bible-search-input');
            const versionSelect = document.getElementById('bible-version-select');
            const searchResultsArea = document.getElementById('bible-search-results-area');
            const searchLoadingIndicator = document.getElementById('bible-search-loading-indicator');

            if (!searchInput || !versionSelect || !searchResultsArea || !searchLoadingIndicator) return;

            const searchTerm = searchInput.value.trim();
            const selectedVersion = versionSelect.value;

            if (!searchTerm || !selectedVersion) {
                showNotification("Por favor, digite uma palavra-chave e selecione uma vers√£o.", 'error');
                return;
            }

            searchResultsArea.innerHTML = '';
            searchLoadingIndicator.classList.remove('hidden');

            const apiUrl = `https://www.abibliadigital.com.br/api/verses/search`;
            const payload = {
                version: selectedVersion,
                search: searchTerm
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.verses && data.verses.length > 0) {
                    let formattedOutput = `
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Resultados da Busca para "${searchTerm}" (${data.occurrence} ocorr√™ncias na vers√£o ${data.version})</h4>
                    `;
                    data.verses.forEach(verse => {
                        formattedOutput += `
                            <p class="mb-1">
                                <span class="font-semibold">${verse.book.name} ${verse.chapter}:${verse.number}.</span> ${verse.text}
                            </p>
                        `;
                    });
                    searchResultsArea.innerHTML = formattedOutput;
                    showNotification(`${data.occurrence} vers√≠culo(s) encontrado(s)!`, 'success');
                } else {
                    searchResultsArea.innerHTML = `<p class="text-red-500">Nenhum vers√≠culo encontrado para "${searchTerm}" na vers√£o selecionada.</p>`;
                    showNotification("Nenhum resultado encontrado.", 'info');
                    console.warn("Nenhum resultado ou erro na busca da API da B√≠blia:", data);
                }
            } catch (error) {
                searchResultsArea.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar vers√≠culos. Verifique sua conex√£o ou tente novamente mais tarde.</p>`;
                showNotification("Erro na conex√£o com a API de Busca da B√≠blia.", 'error');
                console.error("Erro na chamada da API de Busca da B√≠blia:", error);
            } finally {
                searchLoadingIndicator.classList.add('hidden');
            }
        };


        // Fun√ß√£o para popular o dropdown de livros da B√≠blia
        const populateBibleBooksDropdown = () => {
            const bookSelect = document.getElementById('bible-book-select');
            if (bookSelect) {
                // Adiciona uma op√ß√£o padr√£o
                let defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Selecione um livro";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                bookSelect.appendChild(defaultOption);

                bibleBooks.forEach(book => {
                    let option = document.createElement('option');
                    // Usar a abrevia√ß√£o em portugu√™s para a API abibliadigital.com.br
                    option.value = book.abbrev.pt; 
                    option.textContent = book.name;
                    bookSelect.appendChild(option);
                });

                // Pre-seleciona G√™nesis (gn) no dropdown e cap√≠tulo 1
                bookSelect.value = "gn"; 
                const bibleChapterInput = document.getElementById('bible-chapter-input');
                if (bibleChapterInput) bibleChapterInput.value = "1";
            }
        };

        // Fun√ß√£o para popular o dropdown de vers√µes da B√≠blia
        const populateBibleVersionsDropdown = () => {
            const versionSelect = document.getElementById('bible-version-select');
            if (versionSelect) {
                let defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Selecione uma vers√£o";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                versionSelect.appendChild(defaultOption);

                bibleVersions.forEach(version => {
                    let option = document.createElement('option');
                    option.value = version.version;
                    option.textContent = version.version.toUpperCase(); // Exibe a abrevia√ß√£o em mai√∫sculas
                    versionSelect.appendChild(option);
                });

                // Pre-seleciona a vers√£o NVI, se dispon√≠vel
                versionSelect.value = "nvi";
            }
        };

        // Fun√ß√£o para gerar uma ora√ß√£o personalizada usando a API Gemini
        const generatePrayer = async () => {
            const prayerTopicInput = document.getElementById('prayer-topic-input');
            const prayerResponseArea = document.getElementById('prayer-response-area');
            const prayerLoadingIndicator = document.getElementById('prayer-loading-indicator');
            const topic = prayerTopicInput.value.trim();

            if (!topic) {
                showNotification("Por favor, descreva o tema da sua ora√ß√£o.", 'error');
                return;
            }

            if (!prayerResponseArea || !prayerLoadingIndicator) return;

            prayerResponseArea.textContent = ''; // Limpa a √°rea de resposta
            prayerLoadingIndicator.classList.remove('hidden'); // Mostra o indicador de carregamento

            showGlobalLoading(true);
            try {
                const prompt = `Gere uma ora√ß√£o inspiradora e relevante sobre o seguinte tema: "${topic}". Mantenha a ora√ß√£o com cerca de 50-100 palavras.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAXSNFBenSCk7wWscAafWILt45vok8cnMU"; // Chave de API do Gemini fornecida pelo usu√°rio
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    prayerResponseArea.textContent = text;
                    showNotification("Ora√ß√£o gerada com sucesso!", 'success');
                } else {
                    prayerResponseArea.textContent = "N√£o foi poss√≠vel gerar a ora√ß√£o. Tente novamente.";
                    showNotification("Erro ao gerar ora√ß√£o.", 'error');
                    console.error("Estrutura de resposta da API Gemini inesperada para ora√ß√£o:", result);
                }
            } catch (error) {
                prayerResponseArea.textContent = "Ocorreu um erro ao conectar com a IA para gerar a ora√ß√£o. Tente novamente mais tarde.";
                showNotification("Erro na conex√£o com a IA para ora√ß√£o.", 'error');
                console.error("Erro na chamada da API Gemini para ora√ß√£o:", error);
            } finally {
                prayerLoadingIndicator.classList.add('hidden'); // Esconde o indicador de carregamento
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            // Exibe um loading global na tela
            function showGlobalLoading(show) {
                let loadingDiv = document.getElementById('global-loading-indicator');
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'global-loading-indicator';
                    loadingDiv.style.position = 'fixed';
                    loadingDiv.style.top = '0';
                    loadingDiv.style.left = '0';
                    loadingDiv.style.width = '100vw';
                    loadingDiv.style.height = '100vh';
                    loadingDiv.style.background = 'rgba(0,0,0,0.3)';
                    loadingDiv.style.display = 'flex';
                    loadingDiv.style.alignItems = 'center';
                    loadingDiv.style.justifyContent = 'center';
                    loadingDiv.style.zIndex = '9999';
                    loadingDiv.innerHTML = '<div style="background:#fff;padding:32px 48px;border-radius:16px;box-shadow:0 2px 16px #0002;font-size:1.2rem;font-weight:bold;">Carregando...</div>';
                    document.body.appendChild(loadingDiv);
                }
                loadingDiv.style.display = show ? 'flex' : 'none';
            }
            // Adiciona listeners com verifica√ß√µes de exist√™ncia
            // DICA DE SEGURAN√áA: Defina window.GEMINI_API_KEY em ambiente seguro para produ√ß√£o.
            const floatingSendMessageButton = document.getElementById('floating-send-message-button');
            if (floatingSendMessageButton) {
                floatingSendMessageButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    sendMessage();
                });
                floatingSendMessageButton.setAttribute('aria-label', 'Enviar mensagem no chat');
                floatingSendMessageButton.setAttribute('tabindex', '0');
            }

            const addPostButton = document.getElementById('add-post-button');
            if (addPostButton) {
                addPostButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    addPost();
                });
                addPostButton.setAttribute('aria-label', 'Publicar post');
                addPostButton.setAttribute('tabindex', '0');
            }

            const adminButton = document.getElementById('admin-button');
            if (adminButton) {
                adminButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.handleAdminClick();
                });
                adminButton.setAttribute('aria-label', 'Abrir painel de administra√ß√£o');
                adminButton.setAttribute('tabindex', '0');
            }

            // Adicionado listener para o novo bot√£o da B√≠blia
            const bibleButton = document.getElementById('bible-button');
            if (bibleButton) {
                bibleButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.handleBibleClick();
                });
                bibleButton.setAttribute('aria-label', 'Abrir tela da B√≠blia');
                bibleButton.setAttribute('tabindex', '0');
            }

            const toggleFloatingChatButton = document.getElementById('toggle-floating-chat-button');
            if (toggleFloatingChatButton) {
                toggleFloatingChatButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.toggleFloatingChat();
                });
                toggleFloatingChatButton.setAttribute('aria-label', 'Abrir ou fechar chat flutuante');
                toggleFloatingChatButton.setAttribute('tabindex', '0');
            }

            const closeFloatingChatButton = document.getElementById('close-floating-chat-button');
            if (closeFloatingChatButton) {
                closeFloatingChatButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.toggleFloatingChat();
                });
                closeFloatingChatButton.setAttribute('aria-label', 'Fechar chat flutuante');
                closeFloatingChatButton.setAttribute('tabindex', '0');
            }

            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.toggleAuthModal(true); // Chamada corrigida
                });
                loginButton.setAttribute('aria-label', 'Abrir modal de login');
                loginButton.setAttribute('tabindex', '0');
            }

            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleLogout();
                });
                logoutButton.setAttribute('aria-label', 'Fazer logout');
                logoutButton.setAttribute('tabindex', '0');
            }

            const closeAuthModalButton = document.getElementById('close-auth-modal-button');
            if (closeAuthModalButton) closeAuthModalButton.addEventListener('click', () => window.toggleAuthModal(false)); // Chamada corrigida

            const showRegisterFormButton = document.getElementById('show-register-form-button');
            if (showRegisterFormButton) showRegisterFormButton.addEventListener('click', showRegisterForm);

            const showLoginFormButton = document.getElementById('show-login-form-button');
            if (showLoginFormButton) showLoginFormButton.addEventListener('click', showLoginForm);

            const anonymousLoginButton = document.getElementById('anonymous-login-button');
            if (anonymousLoginButton) anonymousLoginButton.addEventListener('click', signInAnonymouslyUser);

            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);

            const registerForm = document.getElementById('register-form');
            if (registerForm) registerForm.addEventListener('submit', handleRegister);

            const closeAdminScreenButton = document.getElementById('close-admin-screen-button');
            if (closeAdminScreenButton) closeAdminScreenButton.addEventListener('click', window.toggleAdminScreen);

            const saveAnonymousUsernameButton = document.getElementById('save-anonymous-username-button');
            if (saveAnonymousUsernameButton) saveAnonymousUsernameButton.addEventListener('click', saveAnonymousUsername);

            const closeUsernameModalButton = document.getElementById('close-username-modal-button');
            if (closeUsernameModalButton) closeUsernameModalButton.addEventListener('click', () => {
                const usernameModal = document.getElementById('username-modal');
                const anonymousUsernameInput = document.getElementById('anonymous-username-input');
                if (usernameModal) usernameModal.classList.add('hidden');
                if (anonymousUsernameInput) anonymousUsernameInput.value = '';
            });

            const generateBibleStudyButton = document.getElementById('generate-bible-study-button');
            if (generateBibleStudyButton) generateBibleStudyButton.addEventListener('click', generateBibleStudy);

            const fetchBibleVerseButton = document.getElementById('fetch-bible-verse-button');
            if (fetchBibleVerseButton) fetchBibleVerseButton.addEventListener('click', fetchBibleVerse);

            const searchBibleButton = document.getElementById('search-bible-button');
            if (searchBibleButton) searchBibleButton.addEventListener('click', searchBibleVerses);

            const generatePrayerButton = document.getElementById('generate-prayer-button');
            if (generatePrayerButton) generatePrayerButton.addEventListener('click', generatePrayer);


            // Popula os dropdowns ao carregar a p√°gina
            populateBibleBooksDropdown();
            populateBibleVersionsDropdown(); 

            initFirebase();
        });
    </script>
</body>
</html>
