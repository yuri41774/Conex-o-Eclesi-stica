<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão Eclesiástica - Início</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f59e42">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Conexão Eclesiástica">
    <link rel="apple-touch-icon" href="/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/global.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 p-4 relative">

    <div id="loading-message" class="flex items-center justify-center min-h-screen bg-gray-100 absolute inset-0 z-10">
        <p class="text-lg sm:text-xl text-gray-700">Carregando aplicação...</p>
    </div>

    <div id="notification-bar" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-green-500 text-white text-center py-3 rounded-b-lg shadow-lg z-50 opacity-0 notification-transition hidden">
        </div>

    <header id="main-header" class="w-full max-w-4xl mx-auto bg-orange-600 text-white p-4 rounded-xl shadow-lg flex justify-between items-center mb-4 z-20 animate-fade-in-down hidden">
        <h1 class="text-2xl sm:text-3xl font-bold">Conexão Eclesiástica</h1>
        <div class="flex items-center space-x-4">
            <div id="user-profile-header" class="flex items-center space-x-2">
                <a id="profile-avatar-link" href="profile.html" title="Ver perfil" class="flex items-center group">
                  <img id="profile-avatar" class="w-10 h-10 rounded-full border-2 border-white bg-gray-200 object-cover transition-all duration-200" src="https://placehold.co/40x40/cccccc/000000?text=👤" alt="Avatar do Usuário">
                  <span class="ml-2 text-white text-base font-semibold group-hover:underline" id="user-name-display">Visitante</span>
                </a>
                <label for="avatar-upload" class="cursor-pointer" title="Alterar avatar">
                  <input type="file" id="avatar-upload" accept="image/*" class="hidden" />
                  <span class="inline-block text-xs text-gray-200 bg-gray-700 px-2 py-1 rounded hover:bg-orange-500">Trocar</span>
                </label>
            </div>
            <button id="hamburger-icon" class="flex flex-col justify-around w-8 h-8 bg-orange-700 p-1 rounded-md cursor-pointer">
                <span class="block h-0.5 bg-white rounded-full"></span>
                <span class="block h-0.5 bg-white rounded-full"></span>
                <span class="block h-0.5 bg-white rounded-full"></span>
            </button>
        </div>
    </header>

    <nav id="hamburger-menu" class="hamburger-menu">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Menu</h2>
            <button id="close-hamburger-menu" class="text-white hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <ul class="flex flex-col space-y-4">
            <li>
                <a href="admin.html" id="menu-admin-button" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 block">
                    Administrador
                </a>
            </li>
            <li>
                <a href="bible.html" id="menu-bible-button" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 block">
                    Bíblia
                </a>
            </li>
            <li id="menu-login-item">
                <button id="menu-login-button" class="w-full text-left bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Login
                </button>
            </li>
            <li id="menu-logout-item" class="hidden">
                <button id="menu-logout-button" class="w-full text-left bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </li>
        </ul>
    </nav>
    <div id="hamburger-menu-overlay" class="hamburger-menu-overlay"></div>

    <div id="app-content" class="hidden bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl mx-auto text-center">
        <p class="text-lg sm:text-xl text-gray-700 mb-6 sm:mb-8 animate-fade-in-up">
            Bem-vindo(a)! Sua plataforma de interação e estudo.
        </p>

        <p class="text-xs sm:text-sm text-gray-500 mb-4 sm:mb-6">
            Seu ID de Usuário: <span id="user-id-display" class="font-mono bg-gray-100 px-2 py-1 rounded-md text-purple-600 break-all"></span>
        </p>

        <div class="mt-4 sm:mt-8 bg-blue-50 p-3 sm:p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-2 sm:mb-4">Mural de Notícias e Posts</h2>
            <div id="posts-container" class="h-48 sm:h-64 overflow-y-auto border border-gray-300 rounded-lg p-2 sm:p-4 mb-2 sm:mb-4 bg-white shadow-sm"></div>
            <div id="add-post-section" class="flex flex-col sm:flex-row gap-2 hidden">
                <textarea
                    id="new-post-content-textarea"
                    placeholder="Escreva seu post aqui..."
                    rows="2"
                    class="flex-grow p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y text-sm sm:text-base"
                ></textarea>
                <button
                    id="add-post-button"
                    class="bg-blue-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-md self-end text-sm sm:text-base"
                >
                    Publicar
                </button>
            </div>
        </div>
    </div>

    <button id="toggle-floating-chat-button" class="fixed bottom-4 right-4 bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-full shadow-lg z-50 transition duration-300 text-2xl font-bold hidden">
        💬
    </button>

    <div id="floating-chat-container" class="hidden fixed bottom-20 right-4 w-80 h-[400px] bg-white rounded-lg shadow-2xl flex flex-col z-40 overflow-hidden">
        <div class="bg-purple-700 text-white p-2 sm:p-3 flex justify-between items-center rounded-t-lg">
            <h3 class="text-base sm:text-lg font-bold">Chat Rápida</h3>
            <button id="close-floating-chat-button" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="floating-messages-container" class="flex-grow overflow-y-auto p-2 sm:p-4 bg-gray-50"></div>
        <div class="p-2 sm:p-4 border-t border-gray-200 flex gap-2">
            <input
                type="text"
                id="floating-new-message-input"
                placeholder="Digite sua mensagem..."
                class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm sm:text-base"
            />
            <button
                id="floating-send-message-button"
                class="bg-purple-600 text-white px-3 sm:px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 ease-in-out shadow-md text-sm sm:text-base"
            >
                Enviar
            </button>
        </div>
    </div>

    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" tabindex="-1" aria-modal="true" role="dialog">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative" tabindex="0">
            <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="flex justify-center mb-6">
                <button id="show-login-form-button" class="px-4 py-2 text-lg font-semibold border-b-2 border-purple-600 text-purple-600 focus:outline-none">Login</button>
                <button id="show-register-form-button" class="px-4 py-2 text-lg font-semibold border-b-2 border-transparent text-gray-500 hover:text-purple-600 focus:outline-none">Registrar</button>
            </div>

            <form id="login-form" class="space-y-4">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Entrar</h2>
                <div>
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2 text-left">Email:</label>
                    <input type="email" id="login-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <!-- Segurança: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div>
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Senha:</label>
                    <input type="password" id="login-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <!-- Segurança: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Entrar
                </button>
                <div class="text-center mt-4">
                    <p class="text-gray-600">ou</p>
                    <button type="button" id="anonymous-login-button" class="mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                        Entrar como Convidado (Anônimo)
                    </button>
                </div>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Registrar</h2>
                <div>
                    <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2 text-left">Email:</label>
                    <input type="email" id="register-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <!-- Segurança: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div>
                    <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Senha:</label>
                    <input type="password" id="register-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <!-- Segurança: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div>
                    <label for="register-confirm-password" class="block text-gray-700 text-sm font-bold mb-2 text-left">Confirmar Senha:</label>
                    <input type="password" id="register-confirm-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="********" required>
                </div>
                <!-- Segurança: autocomplete off -->
                <input type="hidden" autocomplete="off">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-first-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Nome:</label>
                        <input type="text" id="register-first-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div>
                        <label for="register-last-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Sobrenome:</label>
                        <input type="text" id="register-last-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                    </div>
                </div>
                <div>
                    <label for="register-dob" class="block text-gray-700 text-sm font-bold mb-2 text-left">Data de Nascimento:</label>
                    <input type="date" id="register-dob" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div>
                    <label for="register-gender" class="block text-gray-700 text-sm font-bold mb-2 text-left">Gênero:</label>
                    <select id="register-gender" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Selecione</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="register-phone" class="block text-gray-700 text-sm font-bold mb-2 text-left">Telefone:</label>
                    <input type="tel" id="register-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" placeholder="(XX) XXXXX-XXXX">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-street" class="block text-gray-700 text-sm font-bold mb-2 text-left">Rua/Avenida:</label>
                        <input type="text" id="register-street" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-city" class="block text-gray-700 text-sm font-bold mb-2 text-left">Cidade:</label>
                        <input type="text" id="register-city" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-state" class="block text-gray-700 text-sm font-bold mb-2 text-left">Estado:</label>
                        <input type="text" id="register-state" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="register-zip" class="block text-gray-700 text-sm font-bold mb-2 text-left">CEP:</label>
                        <input type="text" id="register-zip" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label for="register-church-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Nome da Igreja (Opcional):</label>
                    <input type="text" id="register-church-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="register-church-role" class="block text-gray-700 text-sm font-bold mb-2 text-left">Função na Igreja:</label>
                    <select id="register-church-role" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Selecione</option>
                        <option value="membro">Membro</option>
                        <option value="lider">Líder</option>
                        <option value="voluntario">Voluntário</option>
                        <option value="pastor">Pastor</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="register-terms" class="mr-2 leading-tight" required>
                    <label for="register-terms" class="text-sm text-gray-700">Eu concordo com os <a href="#" class="text-purple-600 hover:underline">Termos e Condições</a></label>
                </div>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                    Registrar
                </button>
            </form>
        </div>
    </div>

    <div id="username-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" tabindex="-1" aria-modal="true" role="dialog">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm relative text-center" tabindex="0">
            <button id="close-username-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Qual é o seu nome, Convidado?</h2>
            <input type="text" id="anonymous-username-input" placeholder="Digite seu nome" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-purple-500 mb-4" required>
            <button id="save-anonymous-username-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300" autocomplete="off">
                Salvar Nome
            </button>
        </div>
    </div>

    <footer id="main-footer" class="w-full max-w-4xl mx-auto bg-gray-800 text-white p-4 rounded-xl shadow-lg text-center mt-8 hidden">
        <p class="text-xs sm:text-sm">&copy; 2025 Conexão Eclesiástica. Todos os direitos reservados.</p>
        <p class="text-[10px] sm:text-xs mt-2">Desenvolvido com Fé e Tecnologia.</p>
        <p class="text-[10px] sm:text-xs mt-2 opacity-70">Versão: 1.0.0</p>
    </footer>

    <script type="module">
        // --- UPLOAD DE AVATAR ---
        async function uploadAvatar(file) {
            if (!file || !userId) {
                showNotification('Selecione uma imagem e faça login.', 'error');
                return;
            }
            showGlobalLoading(true);
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userId', userId);
                // URL da Edge Function (ajuste conforme seu deploy Supabase)
                const edgeUrl = 'https://db.rahhplphegvvdehrumyp.supabase.co/functions/v1/upload-avatar';
                const response = await fetch(edgeUrl, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Erro desconhecido');
                // Atualiza o avatar na interface
                await fetchAndSetUserAvatar();
                showNotification('Avatar atualizado com sucesso!', 'success');
            } catch (err) {
                showNotification('Erro ao enviar avatar: ' + err.message, 'error');
            } finally {
                showGlobalLoading(false);
            }
        }

        // Busca o avatar do usuário no Supabase e atualiza a interface
        async function fetchAndSetUserAvatar() {
            if (!userId) return;
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('avatar_url, firstName, lastName, email')
                    .eq('id', userId)
                    .single();
                const avatarUrl = data?.avatar_url || 'https://placehold.co/40x40/cccccc/000000?text=👤';
                const avatarImg = document.getElementById('profile-avatar');
                if (avatarImg) {
                    avatarImg.src = avatarUrl;
                }
                // Atualiza nome e e-mail no header
                const userNameDisplay = document.getElementById('user-name-display');
                if (userNameDisplay) {
                    let displayName = data?.firstName || userName || 'Usuário';
                    if (data?.lastName) displayName += ' ' + data.lastName;
                    userNameDisplay.textContent = displayName;
                }
            } catch (e) {
                const avatarImg = document.getElementById('profile-avatar');
                if (avatarImg) {
                    avatarImg.src = 'https://placehold.co/40x40/cccccc/000000?text=👤';
                }
            }
        }
        // --- SEGURANÇA: Função para sanitizar entradas (básico contra XSS) ---
        function sanitizeInput(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"'/]/g, function (c) {
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;'}[c]);
            });
        }

        // --- SUPABASE CONFIG ---
        const supabaseUrl = 'https://db.rahhplphegvvdehrumyp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhaGhwbHBoZWd2dmRlaHJ1bXlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDk2NDMsImV4cCI6MjA2NjI4NTY0M30.EDM-RotlChTCWiisI4o5okQ6Llee1ZaQEAcLaphBqTs';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let userId = null;
        let userName = null;
        let isAuthReady = false;
        const appId = 'conexao-eclesiastica';

        // Dados mock para configurações da aplicação (apenas para simulação, em um projeto real viriam do Firestore)
        let appSettings = {
            welcomeMessage: "Bem-vindo(a) à Conexão Eclesiástica! Que a paz de Deus esteja com você.",
            defaultChatMessage: "Olá a todos! Compartilhem suas bênçãos e orações.",
            allowAnonymousPosting: false,
            publicChatEnabled: true,
            maintenanceMode: false
        };

        // Função para exibir um loading global (spinner ou mensagem)
        function showGlobalLoading(show) {
            let loadingDiv = document.getElementById('global-loading-indicator');
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'global-loading-indicator';
                loadingDiv.style.position = 'fixed';
                loadingDiv.style.top = '0';
                loadingDiv.style.left = '0';
                loadingDiv.style.width = '100vw';
                loadingDiv.style.height = '100vh';
                loadingDiv.style.background = 'rgba(0,0,0,0.3)';
                loadingDiv.style.display = 'flex';
                loadingDiv.style.alignItems = 'center';
                loadingDiv.style.justifyContent = 'center';
                loadingDiv.style.zIndex = '9999';
                loadingDiv.innerHTML = '<div style="background:#fff;padding:32px 48px;border-radius:16px;box-shadow:0 2px 16px #0002;font-size:1.2rem;font-weight:bold;">Carregando...</div>';
                document.body.appendChild(loadingDiv);
            }
            loadingDiv.style.display = show ? 'flex' : 'none';
        }

        // Função para inicializar o Supabase e configurar a autenticação
        const initSupabase = async () => {
            // Checa usuário autenticado
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                userId = user.id;
                userName = user.user_metadata?.firstName || user.email || 'Usuário';
                document.getElementById('user-id-display').textContent = `${userName} (${userId.substring(0, 8)}...)`;
                document.getElementById('add-post-section')?.classList.remove('hidden');
                document.getElementById('menu-login-item')?.classList.add('hidden');
                document.getElementById('menu-logout-item')?.classList.remove('hidden');
                await fetchAndSetUserAvatar();
            } else {
                userId = null;
                userName = null;
                document.getElementById('user-id-display').textContent = 'Não disponível';
                document.getElementById('user-name-display').textContent = 'Visitante';
                const avatarImg = document.getElementById('profile-avatar');
                if (avatarImg) {
                    avatarImg.src = 'https://placehold.co/40x40/cccccc/000000?text=👤';
                }
                document.getElementById('add-post-section')?.classList.add('hidden');
                document.getElementById('menu-login-item')?.classList.remove('hidden');
                document.getElementById('menu-logout-item')?.classList.add('hidden');
            }
            isAuthReady = true;
            document.getElementById('loading-message')?.classList.add('hidden');
            document.getElementById('app-content')?.classList.remove('hidden');
            document.getElementById('main-header')?.classList.remove('hidden');
            document.getElementById('toggle-floating-chat-button')?.classList.remove('hidden');
            document.getElementById('main-footer')?.classList.remove('hidden');
            setupChatListener();
            setupPostsListener();
        };

        const setupChatListener = async () => {
            if (!userId || !isAuthReady) return;
            const { data, error } = await supabase
                .from('chatMessages')
                .select('*')
                .order('timestamp', { ascending: true });
            const messagesContainer = document.getElementById('floating-messages-container');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = '';
            if (error || !data) {
                messagesContainer.innerHTML = '<p class="text-gray-500 italic">Erro ao carregar mensagens.</p>';
                return;
            }
            if (data.length === 0) {
                messagesContainer.innerHTML = '<p class="text-gray-500 italic">Nenhuma mensagem ainda. Seja o primeiro a enviar!</p>';
            } else {
                data.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `mb-2 p-2 rounded-lg max-w-[80%] ${msg.user_id === userId ? 'bg-purple-200 ml-auto text-right' : 'bg-gray-200 mr-auto text-left'}`;
                    const senderDisplayName = msg.sender_name || `Usuário: ${msg.user_id?.substring(0, 8)}...`;
                    const timestampText = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Data desconhecida';
                    msgDiv.innerHTML = `
                        <p class="text-sm font-semibold text-purple-800">${msg.user_id === userId ? 'Você' : senderDisplayName}</p>
                        <p class="text-gray-800">${msg.text}</p>
                        <span class="text-xs text-gray-500">${timestampText}</span>
                    `;
                    messagesContainer.appendChild(msgDiv);
                });
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const setupPostsListener = async () => {
            if (!userId || !isAuthReady) return;
            const { data, error } = await supabase
                .from('posts')
                .select('*')
                .order('timestamp', { ascending: true });
            const postsContainer = document.getElementById('posts-container');
            if (!postsContainer) return;
            postsContainer.innerHTML = '';
            if (error || !data) {
                postsContainer.innerHTML = '<p class="text-gray-500 italic">Erro ao carregar posts.</p>';
                return;
            }
            if (data.length === 0) {
                postsContainer.innerHTML = '<p class="text-gray-500 italic">Nenhum post ainda. Compartilhe algo!</p>';
            } else {
                data.forEach(post => {
                    const postDiv = document.createElement('div');
                    postDiv.className = "mb-4 p-3 border-b border-gray-200 last:border-b-0";
                    const senderDisplayName = post.sender_name || `Usuário: ${post.user_id?.substring(0, 8)}...`;
                    const timestampText = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'Data desconhecida';
                    postDiv.innerHTML = `
                        <p class="text-sm font-semibold text-blue-800">${post.user_id === userId ? 'Você' : senderDisplayName}</p>
                        <p class="text-gray-800 text-lg">${post.content}</p>
                        <span class="text-xs text-gray-500">${timestampText}</span>
                    `;
                    postsContainer.appendChild(postDiv);
                });
            }
            postsContainer.scrollTop = postsContainer.scrollHeight;
        };

        const showNotification = (message, type = 'success') => {
            const notificationBar = document.getElementById('notification-bar');
            if (!notificationBar) return;

            notificationBar.textContent = message;
            notificationBar.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-gray-700');

            if (type === 'success') {
                notificationBar.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationBar.classList.add('bg-red-500');
            } else {
                notificationBar.classList.add('bg-gray-700');
            }

            notificationBar.classList.remove('opacity-0');
            notificationBar.classList.add('opacity-100');

            setTimeout(() => {
                notificationBar.classList.remove('opacity-100');
                notificationBar.classList.add('opacity-0');
                setTimeout(() => {
                    notificationBar.classList.add('hidden');
                }, 500);
            }, 3000);
        };

        const sendMessage = async () => {
            const newMessageInput = document.getElementById('floating-new-message-input');
            if (!newMessageInput) return;
            let newMessage = newMessageInput.value.trim();
            newMessage = sanitizeInput(newMessage);
            if (!userId || !newMessage) {
                showNotification("Por favor, digite uma mensagem.", 'error');
                return;
            }
            try {
                const { error } = await supabase.from('chatMessages').insert([
                    {
                        text: newMessage,
                        user_id: userId,
                        sender_name: sanitizeInput(userName || `Anônimo (${userId.substring(0,4)})`),
                        timestamp: new Date().toISOString(),
                    }
                ]);
                if (error) throw error;
                newMessageInput.value = '';
                showNotification("Mensagem enviada com sucesso!", 'success');
                setupChatListener();
            } catch (error) {
                showNotification("Erro ao enviar mensagem.", 'error');
                console.error("Erro ao enviar mensagem:", error);
            }
        };

        const addPost = async () => {
            const newPostContentTextarea = document.getElementById('new-post-content-textarea');
            if (!newPostContentTextarea) return;
            let newPostContent = newPostContentTextarea.value.trim();
            newPostContent = sanitizeInput(newPostContent);
            if (!userId) {
                showNotification("Você precisa estar logado para postar.", 'error');
                return;
            }
            if (!newPostContent) {
                showNotification("Por favor, digite o conteúdo do post.", 'error');
                return;
            }
            try {
                const { error } = await supabase.from('posts').insert([
                    {
                        content: newPostContent,
                        user_id: userId,
                        sender_name: sanitizeInput(userName),
                        timestamp: new Date().toISOString(),
                    }
                ]);
                if (error) throw error;
                newPostContentTextarea.value = '';
                showNotification("Post publicado com sucesso!", 'success');
                setupPostsListener();
            } catch (error) {
                showNotification("Erro ao publicar post.", 'error');
                console.error("Erro ao publicar post:", error);
            }
        };

        // Funções para o Modal de Autenticação
        const toggleAuthModal = (showLogin = true) => {
            const authModal = document.getElementById('auth-modal');
            if (!authModal) return;
            authModal.classList.toggle('hidden');
            
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (showLogin) {
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
            } else {
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
            }
        };

        const showLoginForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showLoginFormButton = document.getElementById('show-login-form-button');
            const showRegisterFormButton = document.getElementById('show-register-form-button');

            if (loginForm) loginForm.classList.remove('hidden');
            if (registerForm) registerForm.classList.add('hidden');
            
            if (showLoginFormButton) {
                showLoginFormButton.classList.add('border-purple-600', 'text-purple-600');
                showLoginFormButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
            if (showRegisterFormButton) {
                showRegisterFormButton.classList.remove('border-purple-600', 'text-purple-600');
                showRegisterFormButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
        };

        const showRegisterForm = () => {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showLoginFormButton = document.getElementById('show-login-form-button');
            const showRegisterFormButton = document.getElementById('show-register-form-button');

            if (loginForm) loginForm.classList.add('hidden');
            if (registerForm) registerForm.classList.remove('hidden');
            
            if (showRegisterFormButton) {
                showRegisterFormButton.classList.add('border-purple-600', 'text-purple-600');
                showRegisterFormButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
            if (showLoginFormButton) {
                showLoginFormButton.classList.remove('border-purple-600', 'text-purple-600');
                showLoginFormButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-purple-600');
            }
        };

        // Login anônimo Supabase: cria usuário temporário com email fake
        const signInAnonymouslyUser = async () => {
            try {
                // Gera email e senha aleatórios para usuário anônimo
                const randomId = Math.random().toString(36).substring(2, 12);
                const anonEmail = `anon_${randomId}@anon.com`;
                const anonPassword = Math.random().toString(36).substring(2, 12) + 'A!1';
                const { data, error } = await supabase.auth.signUp({ email: anonEmail, password: anonPassword });
                if (error) throw error;
                showNotification("Login como convidado realizado com sucesso!", 'success');
                toggleAuthModal(false);
                // Mostra modal para nome do anônimo
                const usernameModal = document.getElementById('username-modal');
                const anonymousUsernameInput = document.getElementById('anonymous-username-input');
                if (usernameModal) usernameModal.classList.remove('hidden');
                if (anonymousUsernameInput) anonymousUsernameInput.focus();
            } catch (error) {
                showNotification("Erro ao entrar como convidado. Tente novamente.", 'error');
                console.error("Erro no login anônimo:", error);
            }
        };

        // Salva nome do usuário anônimo no perfil Supabase
        const saveAnonymousUsername = async () => {
            let inputName = document.getElementById('anonymous-username-input').value.trim();
            inputName = sanitizeInput(inputName);
            if (!inputName) {
                showNotification("Por favor, digite um nome.", 'error');
                return;
            }
            if (!userId) {
                showNotification("Erro: Usuário não autenticado.", 'error');
                return;
            }
            try {
                // Atualiza o campo firstName no perfil
                const { error } = await supabase.from('profiles').update({ firstName: inputName, isAnonymousProfile: true }).eq('id', userId);
                if (error) throw error;
                userName = inputName;
                document.getElementById('user-id-display').textContent = `${userName} (Anônimo)`;
                showNotification("Nome salvo com sucesso!", 'success');
                const usernameModal = document.getElementById('username-modal');
                const anonymousUsernameInput = document.getElementById('anonymous-username-input');
                if (usernameModal) usernameModal.classList.add('hidden');
                if (anonymousUsernameInput) anonymousUsernameInput.value = '';
            } catch (error) {
                showNotification("Erro ao salvar o nome.", 'error');
                console.error("Erro ao salvar nome anônimo:", error);
            }
        };

        // Registro de usuário Supabase
        const handleRegister = async (event) => {
            event.preventDefault();
            const email = sanitizeInput(document.getElementById('register-email').value);
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const firstName = sanitizeInput(document.getElementById('register-first-name').value);
            const lastName = sanitizeInput(document.getElementById('register-last-name').value);
            const dob = document.getElementById('register-dob').value;
            const gender = sanitizeInput(document.getElementById('register-gender').value);
            const phone = sanitizeInput(document.getElementById('register-phone').value);
            const street = sanitizeInput(document.getElementById('register-street').value);
            const city = sanitizeInput(document.getElementById('register-city').value);
            const state = sanitizeInput(document.getElementById('register-state').value);
            const zip = sanitizeInput(document.getElementById('register-zip').value);
            const churchName = sanitizeInput(document.getElementById('register-church-name').value);
            const churchRole = sanitizeInput(document.getElementById('register-church-role').value);
            const termsAccepted = document.getElementById('register-terms').checked;
            if (password !== confirmPassword) {
                showNotification("As senhas não coincidem.", 'error');
                return;
            }
            if (!termsAccepted) {
                showNotification("Você deve aceitar os termos e condições.", 'error');
                return;
            }
            try {
                // Cria usuário no Supabase Auth
                const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { firstName, lastName, dob, gender, phone, street, city, state, zip, churchName, churchRole, isAnonymousProfile: false } } });
                if (error) throw error;
                showNotification("Registro realizado! Verifique seu e-mail para ativar a conta.", 'success');
                toggleAuthModal(false);
                document.getElementById('register-form').reset();
            } catch (error) {
                let errorMessage = "Erro ao registrar. Tente novamente.";
                if (error.message && error.message.includes('already registered')) {
                    errorMessage = "Este e-mail já está em uso.";
                }
                showNotification(errorMessage, 'error');
                console.error("Erro no registro:", error);
            }
        };

        // Login Supabase
        const handleLogin = async (event) => {
            event.preventDefault();
            const email = sanitizeInput(document.getElementById('login-email').value);
            const password = document.getElementById('login-password').value;
            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showNotification("Login bem-sucedido!", 'success');
                toggleAuthModal(false);
                document.getElementById('login-form').reset();
                await initSupabase();
            } catch (error) {
                let errorMessage = "Erro ao fazer login. Verifique suas credenciais.";
                if (error.message && error.message.includes('Invalid login credentials')) {
                    errorMessage = "E-mail ou senha inválidos.";
                }
                showNotification(errorMessage, 'error');
                console.error("Erro no login:", error);
            }
        };

        // Logout Supabase
        const handleLogout = async () => {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                showNotification("Logout realizado com sucesso!", 'info');
                userId = null;
                userName = null;
                await initSupabase();
            } catch (error) {
                showNotification("Erro ao fazer logout.", 'error');
                console.error("Erro no logout:", error);
            }
        };

        // Funções para o menu hambúrguer e chat flutuante
        const toggleFloatingChat = () => {
            const floatingChatContainer = document.getElementById('floating-chat-container');
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');

            if (!floatingChatContainer) return;

            floatingChatContainer.classList.toggle('hidden');
            if (hamburgerMenu && hamburgerMenu.classList.contains('open')) {
                hamburgerMenu.classList.remove('open');
                if (hamburgerOverlay) hamburgerOverlay.classList.remove('open');
            }
        };

        const toggleHamburgerMenu = () => {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const hamburgerOverlay = document.getElementById('hamburger-menu-overlay');
            const floatingChatContainer = document.getElementById('floating-chat-container');

            if (!hamburgerMenu || !hamburgerOverlay) return;

            hamburgerMenu.classList.toggle('open');
            hamburgerOverlay.classList.toggle('open');

            if (floatingChatContainer && !floatingChatContainer.classList.contains('hidden')) {
                floatingChatContainer.classList.add('hidden');
            }
        };

        // Adiciona listeners ao carregar o DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Upload de avatar
            const avatarUpload = document.getElementById('avatar-upload');
            if (avatarUpload) {
                avatarUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Preview imediato
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            document.getElementById('profile-avatar').src = ev.target.result;
                        };
                        reader.readAsDataURL(file);
                        // Upload para Supabase
                        uploadAvatar(file);
                    }
                });
            }
            // Segurança: Força todos os links externos a terem rel="noopener noreferrer" e target="_blank"
            document.querySelectorAll('a[href^="http"]').forEach(link => {
                link.setAttribute('rel', 'noopener noreferrer');
                link.setAttribute('target', '_blank');
            });

            // Acessibilidade: foco automático em modais
            const authModal = document.getElementById('auth-modal');
            const usernameModal = document.getElementById('username-modal');
            if (authModal) {
                authModal.addEventListener('transitionend', () => {
                    if (!authModal.classList.contains('hidden')) {
                        const firstInput = authModal.querySelector('input, button, select, textarea');
                        if (firstInput) firstInput.focus();
                        // Força foco no modal para acessibilidade
                        const modalContent = authModal.querySelector('.modal-content');
                        if (modalContent) modalContent.focus();
                    }
                });
            }
            if (usernameModal) {
                usernameModal.addEventListener('transitionend', () => {
                    if (!usernameModal.classList.contains('hidden')) {
                        const firstInput = usernameModal.querySelector('input, button');
                        if (firstInput) firstInput.focus();
                        // Força foco no modal para acessibilidade
                        const modalContent = usernameModal.querySelector('.modal-content');
                        if (modalContent) modalContent.focus();
                    }
                });
            }
            // Fecha modais com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (authModal && !authModal.classList.contains('hidden')) {
                        authModal.classList.add('hidden');
                        // Retorna foco ao botão de login
                        document.getElementById('menu-login-button')?.focus();
                    }
                    if (usernameModal && !usernameModal.classList.contains('hidden')) {
                        usernameModal.classList.add('hidden');
                        // Retorna foco ao botão de login
                        document.getElementById('menu-login-button')?.focus();
                    }
                }
                // Acessibilidade: Tab não sai do modal
                const modalOpen = document.querySelector('.modal-overlay:not(.hidden) .modal-content');
                if (modalOpen && (e.key === 'Tab')) {
                    const focusableEls = modalOpen.querySelectorAll('input, button, select, textarea, a[href], [tabindex]:not([tabindex="-1"])');
                    const firstEl = focusableEls[0];
                    const lastEl = focusableEls[focusableEls.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === firstEl) {
                            e.preventDefault();
                            lastEl.focus();
                        }
                    } else {
                        if (document.activeElement === lastEl) {
                            e.preventDefault();
                            firstEl.focus();
                        }
                    }
                }
            });

            // Desabilita botões durante loading
            const floatingSendMessageButton = document.getElementById('floating-send-message-button');
            if (floatingSendMessageButton) {
                floatingSendMessageButton.addEventListener('click', async (e) => {
                    floatingSendMessageButton.disabled = true;
                    await sendMessage();
                    floatingSendMessageButton.disabled = false;
                });
            }
            const addPostButton = document.getElementById('add-post-button');
            if (addPostButton) {
                addPostButton.addEventListener('click', async (e) => {
                    addPostButton.disabled = true;
                    await addPost();
                    addPostButton.disabled = false;
                });
            }
            // Inicializa Supabase
            initSupabase();

            // Esconde a mensagem de carregamento e mostra o conteúdo principal
            document.getElementById('loading-message')?.classList.add('hidden');
            document.getElementById('app-content')?.classList.remove('hidden');
            document.getElementById('main-header')?.classList.remove('hidden');
            document.getElementById('toggle-floating-chat-button')?.classList.remove('hidden');
            document.getElementById('main-footer')?.classList.remove('hidden');

            // Event Listeners para o Cabeçalho e Menu Hambúrguer
            document.getElementById('hamburger-icon')?.addEventListener('click', toggleHamburgerMenu);
            document.getElementById('close-hamburger-menu')?.addEventListener('click', toggleHamburgerMenu);
            document.getElementById('hamburger-menu-overlay')?.addEventListener('click', toggleHamburgerMenu);

            // Event Listeners para o Chat Flutuante
            document.getElementById('toggle-floating-chat-button')?.addEventListener('click', toggleFloatingChat);
            document.getElementById('close-floating-chat-button')?.addEventListener('click', toggleFloatingChat);
            document.getElementById('floating-send-message-button')?.addEventListener('click', sendMessage);

            // Event Listeners para Posts
            document.getElementById('add-post-button')?.addEventListener('click', addPost);

            // Event Listeners para o Modal de Autenticação
            document.getElementById('menu-login-button')?.addEventListener('click', () => toggleAuthModal(true));
            document.getElementById('close-auth-modal-button')?.addEventListener('click', () => toggleAuthModal(false));
            document.getElementById('show-register-form-button')?.addEventListener('click', showRegisterForm);
            document.getElementById('show-login-form-button')?.addEventListener('click', showLoginForm);
            document.getElementById('anonymous-login-button')?.addEventListener('click', signInAnonymouslyUser);
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);

            // Event Listeners para o Modal de Nome de Usuário Anônimo
            document.getElementById('save-anonymous-username-button')?.addEventListener('click', saveAnonymousUsername);
            document.getElementById('close-username-modal-button')?.addEventListener('click', () => {
                document.getElementById('username-modal')?.classList.add('hidden');
                document.getElementById('anonymous-username-input').value = '';
            });

            // Event Listener para o botão de Logout no menu hambúrguer
            document.getElementById('menu-logout-button')?.addEventListener('click', handleLogout);
        });
    </script>
</body>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
        // Service worker registrado
      }, function(err) {
        // Falha ao registrar
        console.warn('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</html>