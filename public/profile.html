<!DOCTYPE html>
<html lang="pt-BR">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usu치rio - Conex칚o Eclesi치stica</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f59e42">
    <link rel="apple-touch-icon" href="/img/logo.png">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="/src/global.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 p-4 flex flex-col items-center">
    <div id="profile-container" class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg mx-auto mt-8 text-center">
        <div class="flex flex-col items-center mb-6">
            <img id="profile-avatar" class="w-24 h-24 rounded-full border-4 border-orange-400 mb-2 object-cover" src="https://placehold.co/96x96/cccccc/000000?text=游녻" alt="Avatar do Usu치rio">
            <label for="avatar-upload" class="cursor-pointer text-xs text-gray-600 bg-gray-200 px-2 py-1 rounded hover:bg-orange-500 hover:text-white transition">Trocar Foto
                <input type="file" id="avatar-upload" accept="image/*" class="hidden" />
            </label>
        </div>
        <h2 id="profile-name" class="text-2xl font-bold text-gray-800 mb-2">Nome do Usu치rio</h2>
        <p id="profile-email" class="text-gray-600 mb-4">email@exemplo.com</p>
        <div class="grid grid-cols-1 gap-2 text-left mb-6">
            <div><span class="font-semibold">Data de Nascimento:</span> <span id="profile-dob">-</span></div>
            <div><span class="font-semibold">G칡nero:</span> <span id="profile-gender">-</span></div>
            <div><span class="font-semibold">Telefone:</span> <span id="profile-phone">-</span></div>
            <div><span class="font-semibold">Endere칞o:</span> <span id="profile-address">-</span></div>
            <div><span class="font-semibold">Igreja:</span> <span id="profile-church">-</span></div>
            <div><span class="font-semibold">Fun칞칚o na Igreja:</span> <span id="profile-role">-</span></div>
        </div>
        <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300 mb-2">Logout</button>
        <a href="index.html" class="block text-center text-sm text-blue-600 hover:underline">Voltar para o in칤cio</a>
    </div>
    <div id="loading-indicator" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 hidden">
        <div class="spinner"></div>
    </div>
    <script type="module">
        // --- SUPABASE CONFIG ---
        const supabaseUrl = 'https://db.rahhplphegvvdehrumyp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhaGhwbHBoZWd2dmRlaHJ1bXlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDk2NDMsImV4cCI6MjA2NjI4NTY0M30.EDM-RotlChTCWiisI4o5okQ6Llee1ZaQEAcLaphBqTs';
        const supabase = window.createClient(supabaseUrl, supabaseKey);
        let userId = null;
        function showLoading(show) {
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
        }

        // Fun칞칚o para buscar e atualizar o avatar do usu치rio
        async function fetchAndSetUserAvatar() {
            if (!userId) return;
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('avatar_url')
                    .eq('id', userId)
                    .single();
                const avatarUrl = data?.avatar_url || 'https://placehold.co/96x96/cccccc/000000?text=游녻';
                const avatarImg = document.getElementById('profile-avatar');
                if (avatarImg) {
                    avatarImg.src = avatarUrl;
                }
            } catch (e) {
                const avatarImg = document.getElementById('profile-avatar');
                if (avatarImg) {
                    avatarImg.src = 'https://placehold.co/96x96/cccccc/000000?text=游녻';
                }
            }
        }

        async function loadProfile() {
            showLoading(true);
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            userId = user.id;
            document.getElementById('profile-name').textContent = user.user_metadata?.firstName || user.email || 'Usu치rio';
            document.getElementById('profile-email').textContent = user.email;
            // Buscar dados extras do perfil (ajuste conforme seu schema)
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', userId).single();
            document.getElementById('profile-dob').textContent = profile?.dob || '-';
            document.getElementById('profile-gender').textContent = profile?.gender || '-';
            document.getElementById('profile-phone').textContent = profile?.phone || '-';
            document.getElementById('profile-address').textContent = profile?.address ? `${profile.address.street || ''}, ${profile.address.city || ''}, ${profile.address.state || ''}, ${profile.address.zip || ''}` : '-';
            document.getElementById('profile-church').textContent = profile?.churchName || '-';
            document.getElementById('profile-role').textContent = profile?.churchRole || '-';
            await fetchAndSetUserAvatar();
            showLoading(false);
        }

        document.getElementById('logout-button').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });

        document.getElementById('avatar-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !userId) return;
            showLoading(true);
            // Preview imediato
            const reader = new FileReader();
            reader.onload = function(ev) {
                document.getElementById('profile-avatar').src = ev.target.result;
            };
            reader.readAsDataURL(file);
            // Upload para Edge Function
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userId', userId);
                const edgeUrl = 'https://db.rahhplphegvvdehrumyp.supabase.co/functions/v1/upload-avatar';
                const response = await fetch(edgeUrl, { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Erro desconhecido');
                // Atualiza avatar_url no perfil
                await supabase.from('profiles').update({ avatar_url: result.publicUrl }).eq('id', userId);
                // Busca novamente o avatar atualizado do backend
                await fetchAndSetUserAvatar();
            } catch (err) {
                alert('Erro ao enviar avatar: ' + err.message);
            } finally {
                showLoading(false);
            }
        });

        loadProfile();
    </script>
</body>
</html>
